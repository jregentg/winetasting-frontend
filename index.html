<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wine Tasting App - Multi-utilisateurs (v2.0 - Fixed)</title>
    <script src="api.js"></script>
    <style>
        /* CSS intégré pour éviter les problèmes de chargement */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --wine-primary: #8B0000;
            --wine-primary-dark: #5D0000;
            --wine-accent: #DAA520;
            --wine-accent-light: #F5F1E8;
            
            --bg-primary: #FAFAFA;
            --bg-card: #FFFFFF;
            --text-primary: #212121;
            --text-secondary: #424242;
            --text-white: #FFFFFF;
            --error: #F44336;
            
            --shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 30px rgba(0, 0, 0, 0.15);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #f0f0f0 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .app-container {
            min-height: 100vh;
            position: relative;
        }

        .screen {
            display: none;
            min-height: 100vh;
            animation: fadeIn 0.5s ease-out;
            position: relative;
            top: 0;
            left: 0;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10;
        }

        /* Forcer le positionnement des écrans admin */
        #admin-sessions-screen.active {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100vh !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            background: var(--background);
            z-index: 1001; /* Au-dessus de la progress-bar (1000) */
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch; /* Améliore le scroll sur iOS */
            scroll-behavior: smooth; /* Scroll fluide */
        }
        
        /* S'assurer que les conteneurs internes n'interfèrent pas avec le scroll */
        #admin-sessions-screen.active .typeform-container {
            min-height: 100vh;
            padding-top: 1rem; /* Espace réduit maintenant que le header est sticky */
            padding-bottom: 2rem; /* Espace en bas pour le scroll */
        }
        
        /* S'assurer que le titre et le premier élément sont visibles */
        #admin-sessions-screen.active .question-wrapper {
            margin-top: 0.5rem; /* Petit espace supplémentaire en haut */
        }
        
        /* Réduire la taille du header pour économiser l'espace */
        #admin-sessions-screen.active .question-title {
            font-size: 1.5rem !important; /* Plus petit que la normale */
            margin-bottom: 0.5rem !important;
        }
        
        #admin-sessions-screen.active .question-subtitle {
            font-size: 0.9rem !important; /* Plus petit */
            margin-bottom: 0.5rem !important;
        }
        
        /* S'assurer que toutes les sessions sont visibles */
        #admin-sessions-screen.active .session-item {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            margin-bottom: 1rem;
        }
        
        /* Debug : colorer la première session pour la repérer */
        #admin-sessions-screen.active .session-item:first-child {
            border-left: 4px solid #ff0000 !important;
            background-color: #fff5f5 !important;
        }
        
        
        /* Solution radicale : header fixe + zone de scroll séparée */
        #admin-sessions-screen.active .question-wrapper {
            position: sticky;
            top: 0.5rem; /* Petit décalage pour être visible */
            background: var(--background);
            z-index: 10;
            padding: 0.5rem 0 1rem 0; /* Padding interne pour espacement */
            margin-bottom: 1rem;
            border-radius: 8px; /* Pour un meilleur rendu visuel */
        }
        
        #admin-sessions-screen.active .admin-section {
            max-height: calc(100vh - 150px); /* Hauteur max réduite pour la zone de liste */
            overflow-y: auto; /* Scroll séparé pour la liste */
            padding: 0.5rem 0; /* Padding réduit */
        }
        
        /* Boutons plus petits */
        .btn-small {
            padding: 0.4rem 0.8rem !important;
            font-size: 0.8rem !important;
            border-radius: 4px !important;
        }
        
        .btn-small .icon {
            font-size: 0.9rem !important;
            margin-right: 0.3rem !important;
        }
        
        /* Styles pour les onglets de gestion de session */
        .session-tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 2px solid #eee;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 0.8rem 1.2rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            color: #666;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .tab-btn:hover {
            background: #f5f5f5;
            color: #333;
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: #f8f9ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Styles pour le résumé de session */
        .session-summary {
            display: flex;
            gap: 2rem;
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .summary-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        .session-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        /* Style pour la 5ème ligne des sessions (boutons) */
        .session-line-5 {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #eee;
        }
        
        /* Styles pour l'affichage des participants sur 5 lignes */
        .participant-display {
            width: 100%;
        }
        
        .participant-line-1 {
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
            font-weight: bold;
        }
        
        .participant-line-2 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }
        
        .participant-line-3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }
        
        .participant-line-4 {
            font-size: 14px;
            margin-bottom: 0.3rem;
        }
        
        .participant-line-5 {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #eee;
        }
        
        .participant-actions-inline {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-start;
        }
        
        /* Styles pour les statuts des participants */
        .status.pending {
            color: #ff9800;
            font-weight: 500;
        }
        
        .status.active {
            color: #4caf50;
            font-weight: 500;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-wrapper, .typeform-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            box-sizing: border-box;
            width: 100%;
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: rgba(139, 0, 0, 0.1);
            z-index: 1000;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--wine-primary), var(--wine-accent));
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0 2px 2px 0;
            width: 0%;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .wine-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        .main-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--wine-primary);
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .action-cards {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            border: 1px solid rgba(139, 0, 0, 0.1);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .primary-card {
            background: linear-gradient(135deg, var(--wine-primary), var(--wine-primary-dark));
            color: var(--text-white);
            border: none;
        }

        .primary-card .card-content h3 {
            color: var(--text-white);
        }

        .card-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .card-content {
            flex: 1;
        }

        .card-content h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .card-arrow {
            font-size: 1.2rem;
            opacity: 0.7;
            transition: var(--transition);
        }

        .card:hover .card-arrow {
            transform: translateX(4px);
            opacity: 1;
        }

        /* Cartes d'administration */
        .admin-card {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: var(--text-white);
            border: none;
        }

        .admin-card .card-content h3 {
            color: var(--text-white);
        }

        .admin-card .card-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            margin: 0.25rem 0 0 0;
        }

        .stats-footer {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .question-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 100%;
        }

        .question-number {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-weight: 500;
        }

        .question-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .question-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 3rem;
            line-height: 1.5;
        }

        .answer-section {
            margin-bottom: 3rem;
        }

        .number-picker {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .number-btn {
            width: 50px;
            height: 50px;
            border: 2px solid var(--wine-primary);
            background: transparent;
            color: var(--wine-primary);
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .number-btn:hover:not(:disabled) {
            background: var(--wine-primary);
            color: var(--text-white);
            transform: scale(1.05);
        }

        .number-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #bottle-count {
            font-size: 2rem;
            font-weight: 700;
            color: var(--wine-primary);
            min-width: 60px;
            text-align: center;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-card);
            border: 2px solid transparent;
            margin-top: 1rem;
        }

        .checkbox-option:hover {
            background: var(--wine-accent-light);
            border-color: var(--wine-accent);
        }

        .checkbox-option input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 24px;
            height: 24px;
            border: 2px solid var(--wine-primary);
            border-radius: 4px;
            position: relative;
            flex-shrink: 0;
            transition: var(--transition);
        }

        .checkbox-option input[type="checkbox"]:checked + .checkmark {
            background: var(--wine-primary);
        }

        .checkbox-option input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-white);
            font-size: 14px;
            font-weight: 600;
        }

        .rating-scale {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        .rating-btn {
            width: 60px;
            height: 60px;
            border: 2px solid #e0e0e0;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rating-btn:hover {
            border-color: var(--wine-primary);
            background: var(--wine-accent-light);
            color: var(--wine-primary);
            transform: translateY(-2px);
        }

        .rating-btn.selected {
            background: var(--wine-primary);
            border-color: var(--wine-primary);
            color: var(--text-white);
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
        }

        .choice-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 2rem 0;
        }

        .choice-option {
            padding: 1.25rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            background: var(--bg-card);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .choice-option:hover {
            border-color: var(--wine-primary);
            background: var(--wine-accent-light);
        }

        .choice-option.selected {
            background: var(--wine-primary);
            border-color: var(--wine-primary);
            color: var(--text-white);
        }

        .choice-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .choice-desc {
            font-size: 14px;
            opacity: 0.8;
        }

        .navigation-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            padding: 0.875rem 2rem;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            min-height: 48px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: var(--wine-primary);
            color: var(--text-white);
            box-shadow: 0 2px 10px rgba(139, 0, 0, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--wine-primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(139, 0, 0, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            border-color: var(--wine-primary);
            color: var(--wine-primary);
            background: var(--wine-accent-light);
        }

        .btn-danger {
            background: var(--error);
            color: var(--text-white);
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 12px 24px;
            font-size: 14px;
            min-height: 44px;
        }

        /* Styles administration */
        .admin-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--wine-accent-light);
            border-radius: 12px;
            border: 1px solid #e8e8e8;
        }

        .admin-section h3 {
            margin: 0 0 1rem 0;
            color: var(--wine-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Responsive pour mobile */
        @media (max-width: 768px) {
            .admin-section {
                padding: 0.75rem;
                margin-bottom: 1.5rem;
                width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }
            
            .admin-section h3 {
                font-size: 1rem;
                word-wrap: break-word;
            }
        }

        /* Améliorations tactiles pour mobile */
        @media (max-width: 768px) {
            /* Améliorer la zone de toucher */
            button, .btn-primary, .btn-secondary, .btn-danger, 
            input[type="button"], input[type="submit"], .clickable {
                min-height: 48px !important;
                min-width: 48px !important;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(139, 0, 0, 0.3);
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }
            
            /* Forcer le mode tactile */
            * {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            /* Permettre la sélection de texte dans les inputs */
            input, textarea, select {
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
                user-select: text;
            }
            
            /* Améliorer la réactivité tactile */
            .wine-icon, .main-title, .question-title {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            /* Fix pour les événements tactiles */
            body {
                -webkit-overflow-scrolling: touch;
                touch-action: pan-y;
            }
        }

        .participants-grid, .sessions-grid, .bottles-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
            width: 100%;
            box-sizing: border-box;
        }

        .participant-item, .session-item, .bottle-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* Responsive pour mobile */
        @media (max-width: 768px) {
            .participant-item, .session-item, .bottle-item {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .participant-actions, .session-actions, .bottle-actions {
                justify-content: stretch;
            }
            
            .participant-actions button, .session-actions button, .bottle-actions button {
                flex: 1;
            }
        }

        .participant-info, .session-info, .bottle-info {
            flex: 1;
        }

        .participant-info strong, .session-info strong, .bottle-info strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .participant-info .email, .session-info .details, .bottle-info .details {
            display: block;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .status.active {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status.pending {
            background: #fff3e0;
            color: #f57c00;
        }

        .status.setup {
            background: #e3f2fd;
            color: #1976d2;
        }

        .participant-actions, .session-actions, .bottle-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Nouveau design pour les sessions - structure 4 lignes */
        .session-display {
            width: 100%;
        }

        .session-line-1 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .session-line-2 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .session-line-3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .session-line-4 {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-actions-inline {
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 768px) {
            .session-line-3 {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .session-line-4 {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .session-actions-inline {
                justify-content: stretch;
            }
            
            .session-actions-inline button {
                flex: 1;
                font-size: 14px;
                padding: 0.4rem 0.6rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }

        /* Styles pour la sélection de session */
        .session-details {
            display: block;
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 0.25rem;
        }

        .empty-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
            font-style: italic;
        }

        .loading-message {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
        }

        /* Styles pour les résultats de session */
        .session-summary {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .summary-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            margin: 0 0 1rem 0;
            color: var(--wine-primary);
            font-size: 1.1rem;
        }

        .summary-card p {
            margin: 0.5rem 0;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .session-summary {
                gap: 1rem;
            }
            
            .summary-card {
                padding: 1rem;
            }
        }

        /* Styles pour la modal */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .modal-close:hover {
            background-color: var(--wine-accent-light);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .modal-body strong {
            color: var(--text-primary);
        }

        .modal-footer {
            padding: 1rem 1.5rem 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Styles pour les boutons d'administration */
        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Augmenter l'espace entre les boutons */
        }

        .admin-btn {
            width: 100%; /* Même largeur que le bouton "Effacer toutes les données" */
            padding: 1rem;
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            text-align: left;
        }

        .admin-btn:hover {
            border-color: var(--wine-primary);
            background: var(--wine-accent-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.15);
        }

        .admin-btn-icon {
            font-size: 2rem;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--wine-accent-light);
            border-radius: 8px;
            flex-shrink: 0;
        }

        .admin-btn-content {
            flex: 1;
        }

        .admin-btn-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .admin-btn-desc {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .celebration-icon {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .score-card {
            background: linear-gradient(135deg, var(--wine-primary), var(--wine-primary-dark));
            color: var(--text-white);
            padding: 2rem;
            border-radius: var(--border-radius);
            text-align: center;
            margin: 2rem 0;
            box-shadow: var(--shadow-hover);
        }

        .score-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .final-score {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .score-description {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .stats-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            box-shadow: var(--shadow);
        }

        .stats-card h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .wine-info-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--wine-primary);
        }

        .wine-info-card h3 {
            margin-bottom: 1rem;
            color: var(--wine-primary);
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .empty-state p {
            margin-bottom: 2rem;
        }

        .history-item {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--wine-primary);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--wine-primary);
        }

        .history-date {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .wine-name {
            color: var(--wine-primary);
            font-weight: 600;
            font-size: 1rem;
            margin: 0.5rem 0;
            line-height: 1.4;
        }

        .history-description {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .history-user {
            color: var(--wine-primary);
            font-size: 14px;
            font-weight: 500;
            margin: 0.5rem 0;
        }

        .history-wine {
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
            margin: 0.5rem 0;
            background: rgba(138, 43, 226, 0.1);
            padding: 0.3rem 0.5rem;
            border-radius: 0.25rem;
        }

        /* Rankings Styles */
        .ranking-item {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--wine-primary);
            transition: var(--transition);
        }

        .ranking-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(138, 43, 226, 0.15);
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .ranking-position {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rank-number {
            background: var(--wine-primary);
            color: white;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .rank-number.gold {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #b8860b;
        }

        .rank-number.silver {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #696969;
        }

        .rank-number.bronze {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            color: #8b4513;
        }

        .bottle-identifier {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--wine-primary);
        }

        .ranking-score {
            text-align: right;
        }

        .average-score {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--wine-primary);
            line-height: 1;
        }

        .score-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ranking-wine {
            color: var(--primary-color);
            font-size: 1rem;
            font-weight: 600;
            margin: 0.5rem 0;
            background: rgba(138, 43, 226, 0.1);
            padding: 0.3rem 0.5rem;
            border-radius: 0.25rem;
        }

        .ranking-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--wine-primary);
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .settings-section {
            margin: 2rem 0;
        }

        .settings-section h3 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }

        .setting-info {
            flex: 1;
        }

        .setting-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .setting-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: var(--transition);
            border-radius: 26px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background-color: var(--wine-primary);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .danger-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #ffeaea;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--error);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--bg-card);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--wine-primary);
            background: var(--wine-accent-light);
        }

        .error-message {
            background: #ffebee;
            color: var(--error);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            border-left: 4px solid var(--error);
        }

        .success-message {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
            border-left: 4px solid #4caf50;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--wine-primary);
            text-decoration: underline;
            cursor: pointer;
            font-size: 14px;
            margin-top: 0.5rem;
        }

        .btn-link:hover {
            color: var(--wine-primary-dark);
        }

        .user-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        .user-info span {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        #username {
            font-weight: 600;
            color: var(--wine-primary);
        }

        @media (max-width: 640px) {
            .content-wrapper, .typeform-container {
                padding: 1.5rem 1rem;
                max-width: 100%;
                margin: 0;
            }
            
            .main-title {
                font-size: 2rem;
            }
            
            .question-title {
                font-size: 1.8rem;
            }
            
            .rating-scale {
                gap: 0.5rem;
            }
            
            .rating-btn {
                width: 50px;
                height: 50px;
                font-size: 1rem;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
            
            .btn-primary, .btn-secondary, .btn-danger {
                width: 100%;
                min-width: auto;
            }
            
            .final-score {
                font-size: 2.5rem;
            }
            
            .number-picker {
                gap: 1.5rem;
            }
        }
        
        /* === CSS POUR LES DÉGUSTATIONS === */
        
        /* Grille des sessions */
        .sessions-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .session-card {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .session-card:hover {
            border-color: #7C3AED;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.1);
            transform: translateY(-2px);
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .session-header h3 {
            margin: 0;
            color: #333;
        }
        
        .session-status {
            background: #22C55E;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .session-info p {
            margin: 0.5rem 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .session-actions {
            margin-top: 1rem;
        }
        
        /* Interface de dégustation */
        .bottle-tasting-interface {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .tasting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .session-info h3 {
            margin: 0;
            color: #7C3AED;
        }
        
        .session-info p {
            margin: 0.5rem 0 0 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .bottle-counter {
            background: #7C3AED;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .bottle-details {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .bottle-details h2 {
            margin: 0 0 1rem 0;
            color: #333;
        }
        
        .wine-details {
            color: #666;
            font-style: italic;
            margin: 0;
        }
        
        /* Questions de dégustation */
        .tasting-questions {
            space-y: 1.5rem;
        }
        
        .question-group {
            margin-bottom: 1.5rem;
        }
        
        .question-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        
        .rating-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .rating-group input[type="range"] {
            flex: 1;
            height: 8px;
            background: #e5e7eb;
            outline: none;
            border-radius: 4px;
            -webkit-appearance: none;
        }
        
        .rating-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #7C3AED;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .rating-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #7C3AED;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .rating-value {
            min-width: 50px;
            text-align: center;
            font-weight: 600;
            color: #7C3AED;
        }
        
        .question-group select,
        .question-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .question-group select:focus,
        .question-group textarea:focus {
            outline: none;
            border-color: #7C3AED;
        }
        
        .question-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Actions de dégustation */
        .tasting-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }
        
        /* Résultats de dégustation */
        .tasting-results {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .results-summary {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }
        
        .average-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .score-label {
            font-size: 1.1rem;
            color: #666;
        }
        
        .score-value {
            font-size: 3rem;
            font-weight: bold;
            color: #7C3AED;
        }
        
        .save-status {
            margin-top: 1rem;
            color: #22C55E;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .bottles-results {
            text-align: left;
        }
        
        .results-list {
            space-y: 1rem;
        }
        
        .result-item {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .bottle-info {
            margin-bottom: 1rem;
        }
        
        .bottle-scores {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        
        .bottle-scores .score {
            background: #f3f4f6;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .bottle-scores .total {
            background: #7C3AED;
            color: white;
        }
        
        .bottle-scores .average {
            background: #22C55E;
            color: white;
            font-weight: 600;
        }
        
        .bottle-notes {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            font-style: italic;
            color: #666;
        }
        
        .results-actions {
            margin-top: 2rem;
        }
        
        .results-actions p {
            color: #666;
            margin-bottom: 1rem;
        }
        
        /* Responsive design pour les dégustations */
        @media (max-width: 768px) {
            .tasting-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .bottle-counter {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .tasting-actions {
                flex-direction: column;
            }
            
            .bottle-scores {
                justify-content: center;
            }
            
            .score-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="login" class="screen active">
            <div class="typeform-container">
                <div class="question-wrapper">
                    <div class="hero-section">
                        <div class="wine-icon">🍷</div>
                        <h1 class="main-title">Wine Tasting</h1>
                        <p class="subtitle">Connectez-vous à votre compte</p>
                    </div>
                    
                    <div class="login-form">
                        <div class="form-group">
                            <label for="login-email">Email</label>
                            <input type="email" id="login-email" placeholder="votre@email.com" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="login-password">Mot de passe</label>
                            <input type="password" id="login-password" placeholder="Votre mot de passe" required>
                        </div>
                        
                        <div class="navigation-buttons">
                            <button class="btn-primary" onclick="handleLogin()">Se connecter</button>
                        </div>
                        
                        <div style="text-align: center; margin-top: 1rem;">
                            <a href="#" onclick="showForgotPassword()" style="color: #8B4513; text-decoration: none; font-size: 14px;">Mot de passe oublié ?</a>
                        </div>
                        
                        <div id="login-error" class="error-message" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forgot Password Screen -->
        <div id="forgot-password" class="screen">
            <div class="typeform-container">
                <div class="question-wrapper">
                    <div class="hero-section">
                        <div class="wine-icon">🔑</div>
                        <h1 class="main-title">Mot de passe oublié</h1>
                        <p class="subtitle">Saisissez votre email pour recevoir un lien de réinitialisation</p>
                    </div>
                    
                    <div class="forgot-password-form">
                        <div class="form-group">
                            <label for="forgot-email">Email</label>
                            <input type="email" id="forgot-email" placeholder="votre@email.com" required>
                        </div>
                        
                        <div class="navigation-buttons">
                            <button class="btn-primary" onclick="handleForgotPassword()">Envoyer le lien</button>
                            <button class="btn-secondary" onclick="showLogin()">Retour à la connexion</button>
                        </div>
                        
                        <div id="forgot-password-error" class="error-message" style="display: none;"></div>
                        <div id="forgot-password-success" class="success-message" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reset Password Screen -->
        <div id="reset-password" class="screen">
            <div class="typeform-container">
                <div class="question-wrapper">
                    <div class="hero-section">
                        <div class="wine-icon">🔐</div>
                        <h1 class="main-title">Nouveau mot de passe</h1>
                        <p class="subtitle">Choisissez votre nouveau mot de passe</p>
                    </div>
                    
                    <div class="reset-password-form">
                        <div class="form-group">
                            <label for="new-password">Nouveau mot de passe</label>
                            <input type="password" id="new-password" placeholder="8 caractères minimum" required>
                            <small style="color: #666; font-size: 14px; margin-top: 0.25rem; display: block;">
                                Doit contenir : 8+ caractères, 1 minuscule, 1 majuscule, 1 chiffre
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="confirm-password">Confirmer le mot de passe</label>
                            <input type="password" id="confirm-password" placeholder="Confirmez votre mot de passe" required>
                        </div>
                        
                        <div class="navigation-buttons">
                            <button class="btn-primary" onclick="handleResetPassword()">Modifier le mot de passe</button>
                            <button class="btn-secondary" onclick="showLogin()">Retour à la connexion</button>
                        </div>
                        
                        <div id="reset-password-error" class="error-message" style="display: none;"></div>
                        <div id="reset-password-success" class="success-message" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Écran de configuration de mot de passe pour nouveaux participants -->
        <div id="setup-password-screen" class="screen">
            <div class="typeform-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>

                <div class="question-container">
                    <div class="question-header">
                        <h2>🔐 Configuration de votre mot de passe</h2>
                        <p>Bienvenue ! Vous devez configurer votre mot de passe pour accéder à l'application de dégustation.</p>
                    </div>

                    <div class="input-container">
                        <label for="setup-email">Email</label>
                        <input type="email" id="setup-email" placeholder="Votre email" readonly>
                    </div>

                    <div class="input-container">
                        <label for="setup-password">Nouveau mot de passe</label>
                        <input type="password" id="setup-password" placeholder="Choisissez un mot de passe (min. 8 caractères)">
                        <small style="color: #666; font-size: 14px; margin-top: 8px; display: block;">
                            Le mot de passe doit contenir au moins 8 caractères
                        </small>
                    </div>

                    <div class="input-container">
                        <label for="setup-password-confirm">Confirmer le mot de passe</label>
                        <input type="password" id="setup-password-confirm" placeholder="Confirmez votre mot de passe">
                    </div>

                    <div class="error-message" id="setup-error" style="display: none;"></div>

                    <div class="navigation-buttons">
                        <button class="btn-primary" onclick="setupUserPassword()" id="setup-submit-btn">
                            Configurer mon mot de passe
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Menu -->
        <div id="main-menu" class="screen">
            <div class="content-wrapper">
                <div class="hero-section">
                    <div class="wine-icon">🍷</div>
                    <h1 class="main-title">Wine Tasting</h1>
                    <p class="subtitle">Découvrez et évaluez vos vins préférés</p>
                </div>

                <div class="action-cards">

                    <!-- Bouton Dégustations pour les participants uniquement -->
                    <div id="tastings-card" class="card secondary-card" onclick="showTastingsSessions()" style="display: none;">
                        <div class="card-icon">🍷</div>
                        <div class="card-content">
                            <h3>Dégustations</h3>
                            <p class="card-subtitle">Sessions actives</p>
                        </div>
                        <div class="card-arrow">→</div>
                    </div>

                    <div class="card secondary-card" onclick="viewHistory()">
                        <div class="card-icon">📊</div>
                        <div class="card-content">
                            <h3>Historique</h3>
                        </div>
                        <div class="card-arrow">→</div>
                    </div>

                    <div class="card secondary-card" onclick="viewRankings()">
                        <div class="card-icon">🏆</div>
                        <div class="card-content">
                            <h3>Classement</h3>
                        </div>
                        <div class="card-arrow">→</div>
                    </div>

                    <div class="card secondary-card" onclick="openSettings()">
                        <div class="card-icon">⚙️</div>
                        <div class="card-content">
                            <h3>Paramètres</h3>
                        </div>
                        <div class="card-arrow">→</div>
                    </div>
                </div>

                <div class="stats-footer">
                    <span id="stats-text">📈 0 dégustations • ⭐ Note moyenne: --</span>
                    <div class="user-info">
                        <span id="user-welcome">Bienvenue, <span id="username">Utilisateur</span></span>
                        <button class="btn-link" onclick="handleLogout()">Se déconnecter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottle Setup -->
        <div id="bottle-setup" class="screen">
            <div class="typeform-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 20%"></div>
                </div>
                
                <div class="question-wrapper">
                    <div class="question-number">1 / 5</div>
                    <h2 class="question-title">🍷 Configuration de la dégustation</h2>
                    <p class="question-subtitle">Combien de bouteilles souhaitez-vous déguster ?</p>
                    
                    <div class="answer-section">
                        <div class="number-picker">
                            <button class="number-btn" onclick="changeBottleCount(-1)">-</button>
                            <span id="bottle-count">1</span>
                            <button class="number-btn" onclick="changeBottleCount(1)">+</button>
                        </div>
                        
                        <label class="checkbox-option">
                            <input type="checkbox" id="custom-names">
                            <span class="checkmark"></span>
                            <span class="option-text">Personnaliser les noms des bouteilles</span>
                        </label>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-secondary" onclick="goToMain()">Retour</button>
                        <button class="btn-primary" onclick="proceedToBottleNaming()">Continuer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottle Naming (pour multi-bouteilles) -->
        <div id="bottle-naming" class="screen">
            <div class="typeform-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 30%"></div>
                </div>
                
                <div class="question-wrapper">
                    <div class="question-number">2 / 5</div>
                    <h2 class="question-title">🏷️ Identification des bouteilles</h2>
                    <p class="question-subtitle">Donnez un nom à chaque bouteille pour les identifier facilement</p>
                    
                    <div class="answer-section" id="bottle-names-container">
                        <!-- Champs générés dynamiquement -->
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-secondary" onclick="goToBottleSetup()">Retour</button>
                        <button class="btn-primary" onclick="proceedToBottleSelection()">Continuer</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottle Selection (pour multi-bouteilles) -->
        <div id="bottle-selection" class="screen">
            <div class="typeform-container">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 40%"></div>
                </div>
                
                <div class="question-wrapper">
                    <div class="question-number">3 / 5</div>
                    <h2 class="question-title">🎯 Sélection de bouteille</h2>
                    <p class="question-subtitle">Quelle bouteille souhaitez-vous déguster maintenant ?</p>
                    
                    <div class="answer-section" id="bottle-selection-container">
                        <!-- Options générées dynamiquement -->
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-secondary" onclick="goToBottleNaming()">Retour</button>
                        <button class="btn-primary" onclick="startTastingQuestions()">Commencer la dégustation</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasting Questions -->
        <div id="tasting-questions" class="screen">
            <div class="typeform-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="question-progress"></div>
                </div>
                
                <div class="question-wrapper">
                    <div class="question-number" id="current-question">1 / 5</div>
                    <h2 class="question-title" id="question-title">👁️ Aspect visuel</h2>
                    <p class="question-subtitle" id="question-subtitle">Observez la couleur, la limpidité et l'intensité du vin</p>
                    <div class="bottle-identifier" id="current-bottle-id" style="font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; text-align: center;"></div>
                    
                    <div class="answer-section" id="answer-container">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-secondary" id="prev-btn" onclick="previousQuestion()" style="display: none;">Précédent</button>
                        <button class="btn-secondary" onclick="skipQuestion()">Passer</button>
                        <button class="btn-danger" onclick="cancelTasting()" style="background-color: #ff4757; margin-left: auto;">Annuler</button>
                        <button class="btn-primary" id="next-btn" onclick="nextQuestion()" disabled>Suivant</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="screen">
            <div class="typeform-container">
                <div class="question-wrapper">
                    <div class="celebration-icon">🎉</div>
                    <h2 class="question-title">Dégustation terminée !</h2>
                    <p class="question-subtitle">Votre évaluation a été enregistrée</p>
                    
                    <div class="score-card">
                        <div class="score-label">Votre note</div>
                        <div class="final-score" id="final-score">16.5/20</div>
                        <div class="score-description" id="score-description">Très bon vin !</div>
                    </div>
                    
                    <div class="stats-card">
                        <h3>📊 Détails de la dégustation</h3>
                        <div class="stat-row">
                            <span>Questions répondues:</span>
                            <span id="answered-questions">5/5</span>
                        </div>
                        <div class="stat-row">
                            <span>Date:</span>
                            <span id="tasting-date">08/10/2025 14:30</span>
                        </div>
                    </div>
                    
                    <div class="wine-info-card">
                        <h3>🍷 Informations sur le vin (optionnel)</h3>
                        <div class="form-group">
                            <label for="wine-name">Nom du vin</label>
                            <input type="text" id="wine-name" placeholder="Ex: Château Margaux">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="wine-vintage">Millésime</label>
                                <input type="number" id="wine-vintage" placeholder="2020" min="1800" max="2025">
                            </div>
                            <div class="form-group">
                                <label for="wine-region">Région</label>
                                <input type="text" id="wine-region" placeholder="Ex: Bordeaux">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="wine-type">Type de vin</label>
                            <select id="wine-type">
                                <option value="">-- Sélectionner --</option>
                                <option value="Rouge">Rouge</option>
                                <option value="Blanc">Blanc</option>
                                <option value="Rosé">Rosé</option>
                                <option value="Champagne">Champagne</option>
                                <option value="Effervescent">Effervescent</option>
                                <option value="Liquoreux">Liquoreux</option>
                                <option value="Fortifié">Fortifié</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="wine-notes">Notes personnelles</label>
                            <textarea id="wine-notes" placeholder="Vos impressions sur ce vin..." rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-primary" onclick="saveTastingWithWineInfo()">Sauvegarder</button>
                        <button class="btn-secondary" onclick="viewHistory()">Historique</button>
                        <button class="btn-secondary" onclick="goToMain()">Menu principal</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History -->
        <div id="history" class="screen">
            <div class="typeform-container">
                <div class="question-wrapper">
                    <h2 class="question-title">📊 Historique des Dégustations</h2>
                    <p class="question-subtitle" id="history-stats">0 dégustations • Note moyenne: --</p>
                    
                    <div class="history-list" id="history-list">
                        <div class="empty-state">
                            <div class="empty-icon">🍷</div>
                            <h3>Aucune dégustation enregistrée</h3>
                            <p>Participez à une session de dégustation pour voir vos résultats ici</p>
                        </div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-secondary" onclick="goToMain()">Menu principal</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rankings -->
        <div id="rankings" class="screen">
            <div class="typeform-container">
                <div class="question-wrapper">
                    <h2 class="question-title">🏆 Classement des Bouteilles</h2>
                    <p class="question-subtitle" id="rankings-stats">Bouteilles classées par note finale (ordre décroissant)</p>
                    
                    <div class="rankings-list" id="rankings-list">
                        <div class="empty-state">
                            <div class="empty-icon">🍷</div>
                            <h3>Aucune bouteille identifiée</h3>
                            <p>Participez à des sessions de dégustation pour voir le classement</p>
                        </div>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-secondary" onclick="goToMain()">Menu principal</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div id="settings" class="screen">
            <div class="typeform-container">
                <div class="question-wrapper">
                    <h2 class="question-title">⚙️ Paramètres</h2>
                    <p class="question-subtitle">Personnalisez votre expérience</p>
                    
                    <div class="settings-section">
                        <h3>🎛️ Préférences</h3>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Notifications</div>
                                <div class="setting-desc">Recevoir des rappels</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="notifications-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Sauvegarde automatique</div>
                                <div class="setting-desc">Sauvegarder automatiquement</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="autosave-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Mode sombre</div>
                                <div class="setting-desc">Interface sombre</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="darkmode-toggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Section Administration (arbitre seulement) -->
                    <div id="admin-section" class="settings-section" style="display: none; border-top: 2px solid #e74c3c; margin-top: 30px; padding-top: 20px;">
                        <h3>🔑 Administration</h3>
                        
                        <div class="admin-actions">
                            <button class="admin-btn" onclick="showAdminSessions()">
                                <div class="admin-btn-icon">🍷</div>
                                <div class="admin-btn-content">
                                    <div class="admin-btn-title">Gestion des sessions</div>
                                    <div class="admin-btn-desc">Créer et gérer les sessions de dégustation</div>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <div class="danger-section" id="danger-section" style="display: none;">
                        <button class="btn-danger" onclick="resetData()">Effacer toutes les données</button>
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-secondary" onclick="goToMain()">Retour au menu</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Écran de sélection des sessions de dégustation -->
    <div id="tasting-sessions" class="screen">
        <div class="typeform-container">
            <div class="question-wrapper">
                <div id="tasting-sessions-content">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Écran de dégustation des bouteilles -->
    <div id="bottle-tasting" class="screen">
        <div class="typeform-container">
            <div class="progress-bar">
                <div class="progress-fill" id="tasting-progress" style="width: 0%"></div>
            </div>
            
            <div class="question-wrapper">
                <div id="bottle-tasting-content">
                    <!-- Contenu généré dynamiquement -->
                </div>
            </div>
        </div>
    </div>

    <!-- Interface d'administration - Sessions -->
    <div id="admin-sessions-screen" class="screen">
        <div class="typeform-container">
            <div class="question-wrapper">
                <h2 class="question-title">
                    <span class="icon">🍷</span>
                    Gestion des Sessions
                </h2>
                <p class="question-subtitle">Liste des sessions de dégustation</p>
                
                <!-- Sessions actives -->
                <div class="admin-section">
                    <div id="active-sessions-list" class="sessions-grid">
                        <!-- Sera rempli dynamiquement -->
                    </div>
                </div>

                <!-- Gestion des bouteilles pour session sélectionnée -->
                <div id="bottles-management" class="admin-section" style="display: none;">
                    <h3>Bouteilles - <span id="selected-session-name"></span></h3>
                    
                    <div id="old-session-bottles-list" class="bottles-grid">
                        <!-- Sera rempli dynamiquement -->
                    </div>
                    
                    <div class="navigation-buttons">
                        <button class="btn-primary" onclick="showCreateBottle()">
                            <span class="icon">🍾</span>
                            Ajouter une bouteille
                        </button>
                        <button class="btn-secondary" onclick="hideBottlesManagement()">Fermer</button>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn-primary" onclick="showCreateSession()">
                        <span class="icon">➕</span>
                        Créer une session
                    </button>
                    <button class="btn-secondary" onclick="showSettings()">Retour aux paramètres</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface de création de session -->
    <div id="create-session-screen" class="screen">
        <div class="typeform-container">
            <div class="question-wrapper">
                <h2 class="question-title">
                    <span class="icon">➕</span>
                    Créer une Session
                </h2>
                <p class="question-subtitle">Organiser une nouvelle session de dégustation</p>
                
                <!-- Formulaire création session -->
                <div class="admin-section">
                    <div class="form-group">
                        <input type="text" id="new-session-name" placeholder="Nom de la session" required>
                    </div>
                    <div class="form-group">
                        <select id="new-session-type">
                            <option value="standard">Dégustation standard</option>
                            <option value="blind">Dégustation à l'aveugle</option>
                        </select>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn-primary" onclick="createSession()">
                        <span class="icon">✅</span>
                        Confirmer la création
                    </button>
                    <button class="btn-secondary" onclick="showAdminSessions()">Retour à la liste</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface de création de bouteille -->
    <div id="create-bottle-screen" class="screen">
        <div class="typeform-container">
            <div class="question-wrapper">
                <h2 class="question-title">
                    <span class="icon">🍾</span>
                    Ajouter une Bouteille
                </h2>
                <p class="question-subtitle">Ajouter une nouvelle bouteille à la session - <span id="bottle-session-name"></span></p>
                
                <!-- Formulaire création bouteille -->
                <div class="admin-section">
                    <div class="form-group">
                        <input type="number" id="new-bottle-number" placeholder="Numéro de bouteille" min="1" required>
                    </div>
                    <div class="form-group">
                        <input type="text" id="new-bottle-name" placeholder="Nom personnalisé (ex: Saumur, Bordeaux)" required>
                    </div>
                    <div class="form-group">
                        <textarea id="new-bottle-details" placeholder="Détails du vin (JSON ou texte libre)" rows="3"></textarea>
                    </div>
                </div>

                <div id="bottle-creation-success" class="success-message" style="display: none;"></div>
                <div id="bottle-creation-error" class="error-message" style="display: none;"></div>

                <div class="navigation-buttons">
                    <button class="btn-primary" onclick="addBottleToSession()">
                        <span class="icon">✅</span>
                        Confirmer l'ajout
                    </button>
                    <button class="btn-secondary" onclick="backToBottlesManagement()">Retour aux bouteilles</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface de gestion complète d'une session -->
    <div id="session-management-screen" class="screen">
        <div class="typeform-container">
            <div class="question-wrapper">
                <h2 class="question-title">
                    <span class="icon">⚙️</span>
                    Gestion de Session
                </h2>
                <p class="question-subtitle">Session: <span id="current-session-name"></span></p>
                
                <!-- Navigation tabs -->
                <div class="session-tabs">
                    <button id="bottles-tab" class="tab-btn active" onclick="showSessionTab('bottles')">
                        <span class="icon">🍾</span>
                        Bouteilles
                    </button>
                    <button id="participants-tab" class="tab-btn" onclick="showSessionTab('participants')">
                        <span class="icon">👥</span>
                        Participants
                    </button>
                    <button id="launch-tab" class="tab-btn" onclick="showSessionTab('launch')">
                        <span class="icon">🚀</span>
                        Lancer
                    </button>
                </div>

                <!-- Onglet Bouteilles -->
                <div id="session-bottles-tab" class="tab-content active">
                    <div class="admin-section">
                        <div id="session-bottles-list" class="bottles-grid">
                            <!-- Sera rempli dynamiquement -->
                        </div>
                        
                        <div class="navigation-buttons">
                            <button class="btn-primary" onclick="showAddBottleToCurrentSession()">
                                <span class="icon">➕</span>
                                Ajouter une bouteille
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Onglet Participants -->
                <div id="session-participants-tab" class="tab-content">
                    <div class="admin-section">
                        <div id="session-participants-list" class="participants-grid">
                            <!-- Sera rempli dynamiquement -->
                        </div>
                        
                        <div class="navigation-buttons">
                            <button class="btn-primary" onclick="showAddParticipantToCurrentSession()">
                                <span class="icon">➕</span>
                                Ajouter un participant
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Onglet Lancement -->
                <div id="session-launch-tab" class="tab-content">
                    <div class="admin-section">
                        <div class="session-status">
                            <h3>Statut actuel: <span id="current-session-status"></span></h3>
                            
                            <div class="session-summary">
                                <div class="summary-item">
                                    <span class="icon">🍾</span>
                                    <span id="session-bottle-count">0</span> bouteille(s)
                                </div>
                                <div class="summary-item">
                                    <span class="icon">👥</span>
                                    <span id="session-participant-count">0</span> participant(s)
                                </div>
                            </div>
                            
                            <div class="session-actions">
                                <button id="activate-session-btn" class="btn-success" onclick="activateSession()" style="display: none;">
                                    <span class="icon">▶️</span>
                                    Activer la session
                                </button>
                                <button id="complete-session-btn" class="btn-warning" onclick="completeSession()" style="display: none;">
                                    <span class="icon">⏹️</span>
                                    Terminer la session
                                </button>
                                <button id="archive-session-btn" class="btn-secondary" onclick="archiveSession()" style="display: none;">
                                    <span class="icon">📁</span>
                                    Archiver la session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn-secondary" onclick="showAdminSessions()">
                        <span class="icon">←</span>
                        Retour aux sessions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface de création de participant pour une session -->
    <div id="create-session-participant-screen" class="screen">
        <div class="typeform-container">
            <div class="question-wrapper">
                <h2 class="question-title">
                    <span class="icon">👤</span>
                    Ajouter un Participant
                </h2>
                <p class="question-subtitle">Ajouter un participant à la session: <span id="participant-session-name"></span></p>
                
                <!-- Formulaire création participant pour session -->
                <div class="admin-section">
                    <div class="form-group">
                        <input type="text" id="new-session-participant-name" placeholder="Prénom du participant" required>
                    </div>
                    <div class="form-group">
                        <input type="email" id="new-session-participant-email" placeholder="Email du participant" required>
                    </div>
                </div>

                <div id="session-participant-creation-success" class="success-message" style="display: none;"></div>
                <div id="session-participant-creation-error" class="error-message" style="display: none;"></div>

                <div class="navigation-buttons">
                    <button class="btn-primary" onclick="createSessionParticipant()">
                        <span class="icon">✅</span>
                        Créer et inviter le participant
                    </button>
                    <button class="btn-secondary" onclick="backToSessionManagement()">
                        <span class="icon">←</span>
                        Retour à la session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface dashboard pour testeurs -->
    <div id="tester-dashboard-screen" class="screen">
        <div class="typeform-container">
            <div class="question-wrapper">
                <h2 class="question-title">
                    <span class="icon">🍷</span>
                    Mes Sessions de Dégustation
                </h2>
                <p class="question-subtitle">Bienvenue <span id="tester-name"></span>, voici vos sessions</p>
                
                <!-- Navigation tabs pour testeur -->
                <div class="session-tabs">
                    <button id="my-sessions-tab" class="tab-btn active" onclick="showTesterTab('sessions')">
                        <span class="icon">🍷</span>
                        Mes Sessions
                    </button>
                    <button id="my-tastings-tab" class="tab-btn" onclick="showTesterTab('tastings')">
                        <span class="icon">📝</span>
                        Mes Dégustations
                    </button>
                    <button id="my-rankings-tab" class="tab-btn" onclick="showTesterTab('rankings')">
                        <span class="icon">🏆</span>
                        Classements
                    </button>
                </div>

                <!-- Onglet Mes Sessions -->
                <div id="tester-sessions-tab" class="tab-content active">
                    <div class="admin-section">
                        <div id="tester-sessions-list" class="sessions-grid">
                            <!-- Sessions du testeur chargées dynamiquement -->
                        </div>
                    </div>
                </div>

                <!-- Onglet Mes Dégustations -->
                <div id="tester-tastings-tab" class="tab-content">
                    <div class="admin-section">
                        <div id="tester-tastings-list" class="tastings-grid">
                            <!-- Historique des dégustations du testeur -->
                        </div>
                    </div>
                </div>

                <!-- Onglet Classements -->
                <div id="tester-rankings-tab" class="tab-content">
                    <div class="admin-section">
                        <div id="tester-rankings-list" class="rankings-grid">
                            <!-- Classements des sessions du testeur -->
                        </div>
                    </div>
                </div>
                
                <div id="tester-loading" class="loading-message" style="display: none;">
                    Chargement...
                </div>
                
                <div id="tester-error" class="error-message" style="display: none;"></div>
                
                <div class="navigation-buttons">
                    <button class="btn-secondary" onclick="logout()">
                        <span class="icon">🚪</span>
                        Déconnexion
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Interface de gestion des bouteilles -->
    <div id="bottle-management-screen" class="screen">
        <div class="typeform-container">
            <div class="question-wrapper">
                <h2 class="question-title">
                    <span class="icon">🍾</span>
                    Gestion des Bouteilles
                </h2>
                <p class="question-subtitle">Gérer les bouteilles de la session - <span id="bottle-management-session-name"></span></p>
                
                <!-- Actions principales -->
                <div class="admin-actions" style="margin-bottom: 2rem;">
                    <button class="admin-btn" onclick="showCreateBottle()">
                        <div class="admin-btn-icon">➕</div>
                        <div class="admin-btn-content">
                            <strong>Ajouter une bouteille</strong>
                            <p>Ajouter une nouvelle bouteille à cette session</p>
                        </div>
                    </button>
                </div>

                <!-- Liste des bouteilles -->
                <div class="admin-section">
                    <h3>Bouteilles de la session</h3>
                    <div id="session-bottles-list" class="list-container">
                        <!-- Les bouteilles seront chargées ici -->
                    </div>
                </div>

                <div class="navigation-buttons">
                    <button class="btn-secondary" onclick="showAdminSessions()">Retour aux sessions</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal pour changer le statut d'une session -->
    <div id="status-change-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Changer le statut de la session</h3>
                <button class="modal-close" onclick="closeStatusModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Session: <strong id="modal-session-name">-</strong></p>
                <p>Statut actuel: <strong id="modal-current-status">-</strong></p>
                
                <div class="form-group">
                    <label for="new-status-select">Nouveau statut:</label>
                    <select id="new-status-select" class="form-control">
                        <option value="setup">Configuration</option>
                        <option value="active">Active</option>
                        <option value="completed">Terminée</option>
                        <option value="archived">Archivée</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeStatusModal()">Annuler</button>
                <button class="btn-primary" onclick="confirmStatusChange()">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
        // SOLUTION TEMPORAIRE : Fonctions essentielles définies en premier
        console.log('🧪 Chargement des fonctions de base...');
        
        async function handleLogin() {
            console.log('🔧 handleLogin appelée');
            console.log('📱 User Agent:', navigator.userAgent);
            console.log('🌐 Current URL:', window.location.href);
            console.log('🔗 API Base URL:', api ? api.baseURL : 'API non définie');
            
            const email = document.getElementById('login-email')?.value;
            const password = document.getElementById('login-password')?.value;
            
            console.log('📧 Email:', email);
            console.log('🔐 Password length:', password ? password.length : 0);
            
            if (!email || !password) {
                console.log('❌ Champs manquants');
                showError('Veuillez remplir tous les champs', 'login-error');
                return;
            }
            
            try {
                console.log('🔧 Tentative de connexion API:', email);
                
                // Fonction setLoading temporaire si elle n'existe pas encore
                if (typeof setLoading !== 'function') {
                    window.setLoading = function(loading) {
                        console.log('📡 Loading:', loading);
                    };
                }
                
                setLoading(true);
                
                // Utiliser l'API si elle existe, sinon simulation
                if (typeof api !== 'undefined' && api.login) {
                    console.log('🚀 Appel api.login avec:', { email, password: '***' });
                    const response = await api.login(email, password);
                    console.log('✅ Connexion réussie:', response);
                    
                    // Rediriger vers le menu principal et configurer selon le rôle
                    showScreen('main-menu');
                    initializeMenuByRole();
                } else {
                    console.log('⚠️ API non disponible, simulation de connexion');
                    alert('Connexion simulée réussie pour: ' + email);
                    showScreen('main-menu');
                    initializeMenuByRole();
                }
                
                setLoading(false);
            } catch (error) {
                console.error('❌ Erreur de connexion:', error);
                console.error('❌ Stack trace:', error.stack);
                setLoading(false);
                
                let errorMessage = error.message || 'Erreur de connexion';
                if (errorMessage.includes('rate limit') || errorMessage.includes('trop de tentatives')) {
                    errorMessage = 'Trop de tentatives de connexion. Veuillez attendre quelques minutes et réessayer.';
                } else if (errorMessage.includes('Failed to fetch') || errorMessage.includes('Network Error')) {
                    errorMessage = 'Problème de connexion réseau. Vérifiez votre connexion internet.';
                }
                
                showError(errorMessage, 'login-error');
            }
        }
        
        // Fonction showError temporaire si elle n'existe pas
        function showError(message, elementId = 'login-error') {
            console.log('❌ Erreur:', message);
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            } else {
                alert('Erreur: ' + message);
            }
        }

        // Fonction showSuccess manquante
        function showSuccess(message, elementId = 'success-message') {
            console.log('✅ Succès:', message);
            // Essayer de trouver un élément de succès existant
            let successEl = document.getElementById(elementId);
            
            if (!successEl) {
                // Créer un élément temporaire
                successEl = document.createElement('div');
                successEl.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #4CAF50;
                    color: white;
                    padding: 15px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-family: system-ui, sans-serif;
                    max-width: 400px;
                `;
                document.body.appendChild(successEl);
            }
            
            successEl.textContent = message;
            successEl.style.display = 'block';
            
            // Masquer après 3 secondes
            setTimeout(() => {
                if (successEl.parentNode) {
                    successEl.parentNode.removeChild(successEl);
                }
            }, 3000);
        }
        
        function showRegister() {
            console.log('🔧 showRegister appelée');
            showScreen('register');
        }
        
        function showForgotPassword() {
            console.log('🔧 showForgotPassword appelée');
            showScreen('forgot-password');
        }
        
        function showLogin() {
            console.log('🔧 showLogin appelée');
            showScreen('login');
        }
        
        async function handleRegister() {
            console.log('🔧 handleRegister appelée');
            const username = document.getElementById('register-username')?.value;
            const email = document.getElementById('register-email')?.value;
            const password = document.getElementById('register-password')?.value;
            const firstName = document.getElementById('register-firstname')?.value || '';
            const lastName = document.getElementById('register-lastname')?.value || '';
            
            if (!username || !email || !password) {
                showError('Veuillez remplir tous les champs obligatoires');
                return;
            }
            
            console.log('🔧 Tentative d\'inscription:', email);
            
            try {
                const response = await api.register({
                    username,
                    email, 
                    password,
                    firstName,
                    lastName
                });
                
                console.log('✅ Inscription réussie:', response);
                showSuccess('Compte créé avec succès ! Vous pouvez maintenant vous connecter.');
                showLogin(); // Retour à l'écran de connexion
                
            } catch (error) {
                console.error('❌ Erreur d\'inscription:', error);
                showError('Erreur lors de la création du compte: ' + error.message);
            }
        }
        
        function handleForgotPassword() {
            console.log('🔧 handleForgotPassword appelée');
            const email = document.getElementById('forgot-email')?.value;
            
            if (!email) {
                alert('Veuillez saisir votre email');
                return;
            }
            
            console.log('🔧 Demande de réinitialisation:', email);
            alert('Fonction handleForgotPassword fonctionne ! Email: ' + email);
        }
        
        function handleResetPassword() {
            console.log('🔧 handleResetPassword appelée');
            const password = document.getElementById('reset-password')?.value;
            const confirmPassword = document.getElementById('reset-confirm-password')?.value;
            
            if (!password || !confirmPassword) {
                alert('Veuillez remplir tous les champs');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('Les mots de passe ne correspondent pas');
                return;
            }
            
            console.log('🔧 Réinitialisation du mot de passe');
            alert('Fonction handleResetPassword fonctionne !');
        }
        
        function showScreen(screenId) {
            console.log('🔧 showScreen appelée:', screenId);
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                console.log('✅ Écran affiché:', screenId);
            } else {
                console.error('❌ Écran non trouvé:', screenId);
            }
        }
        
        // Fonction pour forcer la déconnexion et voir l'écran de login
        function forceLogoutForTest() {
            console.log('🧪 Déconnexion forcée pour test');
            localStorage.removeItem('wine_tasting_token');
            localStorage.removeItem('wine_tasting_user');
            showScreen('login');
            alert('Déconnecté ! Vous pouvez maintenant tester les boutons de connexion.');
        }
        
        // Fonction de test globale disponible dans la console
        window.testLogin = function() {
            console.log('🧪 Test de l\'écran de connexion');
            forceLogoutForTest();
        };
        
        // === FONCTIONS DU MENU PRINCIPAL ===
        
        function startTasting() {
            const user = api.getCurrentUser();
            
            if (user && user.role === 'arbitre') {
                // Pour les arbitres : redirection directe vers gestion des sessions
                showScreen('admin-sessions-screen');
                if (typeof loadSessions === 'function') {
                    loadSessions();
                }
            } else {
                // Pour les testeurs : affichage de leurs sessions
                showScreen('tester-dashboard-screen');
                loadTesterSessions();
            }
        }
        
        // Fonction pour récupérer l'utilisateur actuel
        function getCurrentUser() {
            try {
                const userStr = localStorage.getItem('wine_tasting_user');
                return userStr ? JSON.parse(userStr) : null;
            } catch (error) {
                console.error('Erreur récupération utilisateur:', error);
                return null;
            }
        }
        
        // Fonction pour afficher les options d'arbitre
        function showArbitreFunctions() {
            console.log('🔧 showArbitreFunctions() appelée');
            console.log('🔧 Redirection directe vers gestion des sessions');
            
            // Redirection directe vers la gestion des sessions
            showAdminSessions();
        }
        
        // Fonctions pour les arbitres
        
        function showAdminSessions() {
            console.log('🔧 showAdminSessions appelée');
            if (!api.isArbitre()) {
                console.error('❌ Not arbitre');
                showError('Accès refusé - Rôle arbitre requis');
                return;
            }
            console.log('✅ Showing admin-sessions-screen');
            showScreen('admin-sessions-screen');
            
            // Remonter en haut de l'écran admin (position fixed)
            setTimeout(() => {
                const adminScreen = document.getElementById('admin-sessions-screen');
                const adminSection = adminScreen ? adminScreen.querySelector('.admin-section') : null;
                
                if (adminSection) {
                    // Scroll sur la zone de liste si elle existe
                    adminSection.scrollTo({ top: 0, behavior: 'smooth' });
                    adminSection.scrollTop = 0;
                    console.log('📜 Scroll vers le haut de la zone admin-section');
                } else if (adminScreen) {
                    // Fallback sur l'écran complet
                    adminScreen.scrollTo({ top: 0, behavior: 'smooth' });
                    adminScreen.scrollTop = 0;
                    console.log('📜 Scroll vers le haut de admin-sessions-screen');
                } else {
                    // Fallback pour les autres écrans
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;
                    console.log('📜 Scroll vers le haut via window (fallback)');
                }
            }, 50);
            
            loadSessions();
        }
        
        // Fonction pour charger les sessions dans l'écran admin
        async function loadSessions() {
            console.log('🔧 loadSessions() appelée');
            try {
                setLoading(true);
                // Forcer le rechargement sans cache
                const response = await fetch(`${api.baseURL}/sessions/admin/all?t=${Date.now()}`, {
                    method: 'GET',
                    headers: api.getHeaders()
                });
                const data = await api.handleResponse(response);
                console.log('📡 Sessions récupérées:', data);
                
                const sessions = data.data || data;
                console.log('👥 Sessions:', sessions);
                
                // Tri par date de création (plus récente en premier)
                sessions.sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                
                const listEl = document.getElementById('active-sessions-list');
                if (!listEl) {
                    console.error('❌ Element active-sessions-list introuvable');
                    return;
                }
                
                console.log('🔄 Vidage de la liste sessions');
                listEl.innerHTML = '';
                
                if (sessions.length === 0) {
                    console.log('📝 Affichage message vide');
                    listEl.innerHTML = '<p class="empty-message">Aucune session créée</p>';
                    setLoading(false);
                    return;
                }
                
                console.log('📋 Affichage de', sessions.length, 'sessions');
                sessions.forEach(session => {
                    const sessionEl = document.createElement('div');
                    sessionEl.className = 'session-item';
                    sessionEl.innerHTML = `
                        <div class="session-display">
                            <div class="session-line-1">
                                <strong>${session.name || 'Session sans nom'}</strong>
                            </div>
                            <div class="session-line-2">
                                Type: ${session.type || 'standard'}
                            </div>
                            <div class="session-line-3">
                                Créée le ${new Date(session.created_at).toLocaleDateString('fr-FR')}
                            </div>
                            <div class="session-line-4">
                                Statut: ${session.status || 'setup'}
                            </div>
                            <div class="session-line-5">
                                <div class="session-actions-inline">
                                    <button class="btn-primary btn-small" onclick="manageTastingSession(${session.id})">
                                        <span class="icon">⚙️</span>
                                        Gérer
                                    </button>
                                    <button class="btn-danger btn-small" onclick="deleteSession(${session.id})">
                                        <span class="icon">🗑️</span>
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    listEl.appendChild(sessionEl);
                    console.log('➕ Session ajoutée à la liste:', session.name);
                });
                
                console.log('✅ Liste sessions mise à jour, total:', sessions.length);
                
            } catch (error) {
                console.error('❌ Erreur chargement sessions:', error);
                showError('Erreur lors du chargement des sessions: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        
        function showCreateSession() {
            console.log('🔧 showCreateSession appelée');
            if (!api.isArbitre()) {
                console.error('❌ Not arbitre');
                showError('Accès refusé - Rôle arbitre requis');
                return;
            }
            console.log('✅ Showing create-session-screen');
            showScreen('create-session-screen');
            
            // Scroll vers le haut
            setTimeout(() => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 50);
        }
        
        function viewHistory() {
            console.log('🔧 viewHistory appelée');
            if (typeof updateHistoryDisplay === 'function') {
                updateHistoryDisplay();
            }
            showScreen('history');
        }
        
        function viewRankings() {
            console.log('🔧 viewRankings appelée');
            if (typeof updateRankingsDisplay === 'function') {
                updateRankingsDisplay();
            }
            showScreen('rankings');
        }
        
        function openSettings() {
            console.log('🔧 openSettings appelée');
            showScreen('settings');
            
            // Afficher/masquer la section administration selon le rôle - directement dans la fonction
            setTimeout(() => {
                console.log('🔧 Gestion affichage admin sections');
                
                const adminSection = document.getElementById('admin-section');
                const dangerSection = document.getElementById('danger-section');
                
                console.log('🔧 Elements trouvés:', {
                    adminSection: !!adminSection,
                    dangerSection: !!dangerSection
                });
                
                const user = api.getCurrentUser();
                const isArbitre = api.isArbitre();
                
                console.log('🔧 Utilisateur:', user);
                console.log('🔧 Est arbitre:', isArbitre);
                
                if (isArbitre) {
                    console.log('✅ Affichage des sections d\'administration');
                    if (adminSection) adminSection.style.display = 'block';
                    if (dangerSection) dangerSection.style.display = 'block';
                } else {
                    console.log('❌ Masquage des sections d\'administration');
                    if (adminSection) adminSection.style.display = 'none';
                    if (dangerSection) dangerSection.style.display = 'none';
                }
            }, 100);
        }
        
        function showSettings() {
            console.log('🔧 showSettings appelée');
            showScreen('settings');
            
            // Afficher/masquer la section administration selon le rôle - directement dans la fonction
            setTimeout(() => {
                console.log('🔧 Gestion affichage admin sections');
                
                const adminSection = document.getElementById('admin-section');
                const dangerSection = document.getElementById('danger-section');
                
                console.log('🔧 Elements trouvés:', {
                    adminSection: !!adminSection,
                    dangerSection: !!dangerSection
                });
                
                const user = api.getCurrentUser();
                const isArbitre = api.isArbitre();
                
                console.log('🔧 Utilisateur:', user);
                console.log('🔧 Est arbitre:', isArbitre);
                
                if (isArbitre) {
                    console.log('✅ Affichage des sections d\'administration');
                    if (adminSection) adminSection.style.display = 'block';
                    if (dangerSection) dangerSection.style.display = 'block';
                } else {
                    console.log('❌ Masquage des sections d\'administration');
                    if (adminSection) adminSection.style.display = 'none';
                    if (dangerSection) dangerSection.style.display = 'none';
                }
            }, 100);
        }
        
        function updateSettingsAccess() {
            console.log('🔧 updateSettingsAccess() appelée');
            
            // Afficher/masquer la section administration selon le rôle
            const adminSection = document.getElementById('admin-section');
            const dangerSection = document.getElementById('danger-section');
            
            console.log('🔧 Elements trouvés:', {
                adminSection: !!adminSection,
                dangerSection: !!dangerSection
            });
            
            const user = api.getCurrentUser();
            const isArbitre = api.isArbitre();
            
            console.log('🔧 Utilisateur:', user);
            console.log('🔧 Est arbitre:', isArbitre);
            
            if (isArbitre) {
                console.log('✅ Affichage des sections d\'administration');
                if (adminSection) adminSection.style.display = 'block';
                if (dangerSection) dangerSection.style.display = 'block';
            } else {
                console.log('❌ Masquage des sections d\'administration');
                if (adminSection) adminSection.style.display = 'none';
                if (dangerSection) dangerSection.style.display = 'none';
            }
        }
        
        function goToMain() {
            console.log('🔧 goToMain appelée');
            showScreen('main-menu');
        }
        
        
        async function deleteSession(sessionId) {
            console.log('🔧 deleteSession() appelée avec ID:', sessionId);
            
            if (!api.isArbitre()) {
                console.error('❌ Not arbitre');
                showError('Accès refusé - Rôle arbitre requis');
                return;
            }
            
            if (!sessionId) {
                showError('ID session manquant');
                return;
            }
            
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette session ? Cette action supprimera définitivement la session et toutes les données associées (dégustations, historiques, classements). Cette action est irréversible.')) {
                return;
            }
            
            try {
                setLoading(true);
                console.log('🗑️ Suppression de la session ID:', sessionId);
                
                const response = await api.deleteSession(sessionId);
                console.log('📡 Réponse suppression session:', response);
                
                if (response.success) {
                    showSuccess('Session supprimée avec succès');
                    console.log('✅ Suppression réussie, rechargement de la liste...');
                    // Petit délai pour s'assurer que la suppression est bien prise en compte
                    setTimeout(() => {
                        console.log('🔄 Appel loadSessions après suppression');
                        loadSessions();
                    }, 500);
                } else {
                    showError('Erreur: ' + (response.message || 'Erreur lors de la suppression'));
                }
                
            } catch (error) {
                console.error('❌ Erreur suppression session:', error);
                showError('Erreur lors de la suppression: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        async function createSession() {
            console.log('🔧 createSession() appelée');
            
            if (!api.isArbitre()) {
                console.error('❌ Not arbitre');
                showError('Accès refusé - Rôle arbitre requis');
                return;
            }

            const nameEl = document.getElementById('new-session-name');
            const typeEl = document.getElementById('new-session-type');
            
            console.log('🔧 Elements trouvés:', {
                name: !!nameEl,
                type: !!typeEl
            });
            
            if (!nameEl) {
                console.error('❌ Élément nom introuvable');
                showError('Erreur: champ nom introuvable');
                return;
            }
            
            const name = nameEl.value.trim();
            const type = typeEl ? typeEl.value : 'standard';
            
            console.log('🔧 Valeurs:', { name, type });
            
            if (!name) {
                console.error('❌ Nom vide');
                showError('Veuillez saisir un nom de session');
                return;
            }
            
            try {
                console.log('📡 Appel API createSession...');
                setLoading(true);
                const response = await api.createSession({ name, type });
                console.log('📡 Réponse API:', response);
                
                if (response.success) {
                    showSuccess('Session créée avec succès');
                    // Vider les champs
                    nameEl.value = '';
                    if (typeEl) typeEl.value = 'standard';
                    // Retourner à la liste
                    showAdminSessions();
                } else {
                    showError('Erreur: ' + response.message);
                }
                
            } catch (error) {
                console.error('❌ Erreur création session:', error);
                showError('Erreur lors de la création: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        function newTasting() {
            console.log('🔧 newTasting appelée');
            showScreen('bottle-setup');
        }
        
        function handleLogout() {
            console.log('🔧 handleLogout appelée');
            localStorage.removeItem('wine_tasting_token');
            localStorage.removeItem('wine_tasting_user');
            showScreen('login');
            alert('Vous avez été déconnecté');
        }
        
        console.log('✅ Fonctions de base définies');
        console.log('💡 Pour voir l\'écran de connexion, tapez: testLogin() dans la console');
    </script>
    
    <script>
        // Test basique pour vérifier si le JavaScript s'exécute
        console.log('🧪 JavaScript started loading...');
        
        // Wine Tasting App - JavaScript Logic (version multi-utilisateurs)
        let currentScreen = 'login';
        let currentQuestionIndex = 0;
        let bottleCount = 1;
        let answers = [];
        let currentUser = null;
        let isLoading = false;
        let resetToken = null;
        let currentFinalScore = 0;
        let bottleNames = [];
        let selectedBottleId = null;

        const questions = [
            {
                id: 'visual',
                icon: '👁️',
                title: 'Aspect visuel',
                subtitle: 'Observez la couleur, la limpidité et l\'intensité du vin',
                type: 'rating'
            },
            {
                id: 'first-nose',
                icon: '👃',
                title: 'Premier nez',
                subtitle: 'Sentez le vin sans l\'agiter. Quelles sont vos premières impressions ?',
                type: 'choice',
                options: [
                    { title: 'Fermé', desc: 'Peu d\'arômes perceptibles', value: 1 },
                    { title: 'Discret', desc: 'Arômes légers mais présents', value: 2 },
                    { title: 'Ouvert', desc: 'Arômes bien présents et identifiables', value: 3 },
                    { title: 'Expressif', desc: 'Arômes intenses et variés', value: 4 },
                    { title: 'Puissant', desc: 'Arômes très intenses et complexes', value: 5 }
                ]
            },
            {
                id: 'second-nose',
                icon: '🌪️',
                title: 'Deuxième nez',
                subtitle: 'Agitez délicatement le verre et sentez à nouveau',
                type: 'choice',
                options: [
                    { title: 'Inchangé', desc: 'Aucune évolution notable', value: 2 },
                    { title: 'Légèrement ouvert', desc: 'Quelques nouveaux arômes', value: 3 },
                    { title: 'Bien ouvert', desc: 'Nette amélioration des arômes', value: 4 },
                    { title: 'Très expressif', desc: 'Explosion d\'arômes complexes', value: 5 }
                ]
            },
            {
                id: 'mouthfeel',
                icon: '👅',
                title: 'Attaque en bouche',
                subtitle: 'Prenez une première gorgée. Comment le vin attaque-t-il vos papilles ?',
                type: 'rating'
            },
            {
                id: 'finish',
                icon: '⏱️',
                title: 'Finale',
                subtitle: 'Après avoir avalé, quelle est la persistance des arômes ?',
                type: 'rating'
            }
        ];

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active');
                currentScreen = screenId;
                updateProgressBar(screenId);
                
                // Force scroll vers le haut pour tous les écrans, surtout mobile
                setTimeout(() => {
                    try {
                        // Méthodes multiples pour assurer la compatibilité mobile
                        window.scrollTo({ top: 0, behavior: 'instant' });
                        document.body.scrollTop = 0;
                        document.documentElement.scrollTop = 0;
                        
                        // Spécifique pour iOS Safari
                        if (window.scrollY > 0) {
                            window.scrollTo(0, 0);
                        }
                    } catch (e) {
                        console.log('Scroll fallback');
                        window.scrollTo(0, 0);
                    }
                }, 10);
            }
        }

        function updateProgressBar(screenId) {
            const progressBar = document.querySelector('.progress-fill');
            if (!progressBar) return;
            
            let progress = 0;
            switch (screenId) {
                case 'bottle-setup':
                    progress = 20;
                    break;
                case 'tasting-questions':
                    progress = 20 + (currentQuestionIndex / questions.length) * 60;
                    break;
                case 'results':
                    progress = 100;
                    break;
                default:
                    progress = 0;
            }
            
            progressBar.style.width = progress + '%';
        }

        function goToMain() {
            showScreen('main-menu');
            resetTasting();
        }

        // Fonction startTasting déplacée plus haut dans le script prioritaire

        function newTasting() {
            resetTasting();
            showScreen('bottle-setup');
        }

        function viewHistory() {
            updateHistoryDisplay();
            showScreen('history');
        }

        function viewRankings() {
            updateRankingsDisplay();
            showScreen('rankings');
        }

        function openSettings() {
            showScreen('settings');
            updateSettingsAccess();
        }

        function showSettings() {
            showScreen('settings');
            updateSettingsAccess();
        }

        function updateSettingsAccess() {
            console.log('🔧 updateSettingsAccess() appelée');
            
            // Afficher/masquer la section administration selon le rôle
            const adminSection = document.getElementById('admin-section');
            const dangerSection = document.getElementById('danger-section');
            
            console.log('🔧 Elements trouvés:', {
                adminSection: !!adminSection,
                dangerSection: !!dangerSection
            });
            
            const user = api.getCurrentUser();
            const isArbitre = api.isArbitre();
            
            console.log('🔧 Utilisateur:', user);
            console.log('🔧 Est arbitre:', isArbitre);
            
            if (isArbitre) {
                console.log('✅ Affichage des sections d\'administration');
                if (adminSection) adminSection.style.display = 'block';
                if (dangerSection) dangerSection.style.display = 'block';
            } else {
                console.log('❌ Masquage des sections d\'administration');
                if (adminSection) adminSection.style.display = 'none';
                if (dangerSection) dangerSection.style.display = 'none';
            }
        }

        function changeBottleCount(delta) {
            const newCount = Math.max(1, Math.min(10, bottleCount + delta));
            bottleCount = newCount;
            document.getElementById('bottle-count').textContent = newCount;
        }

        function proceedToBottleNaming() {
            if (bottleCount === 1) {
                // Une seule bouteille : pas besoin d'identification, aller directement aux questions
                selectedBottleId = 'Bouteille';
                startTastingQuestions();
            } else {
                // Plusieurs bouteilles : aller à l'écran d'identification
                setupBottleNaming();
                showScreen('bottle-naming');
            }
        }

        function setupBottleNaming() {
            const container = document.getElementById('bottle-names-container');
            container.innerHTML = '';
            
            for (let i = 1; i <= bottleCount; i++) {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                
                formGroup.innerHTML = `
                    <label for="bottle-name-${i}">Bouteille ${i}</label>
                    <input type="text" id="bottle-name-${i}" placeholder="Ex: Bordeaux rouge, Cuvée spéciale..." required>
                `;
                
                container.appendChild(formGroup);
            }
        }

        function proceedToBottleSelection() {
            // Récupérer les noms saisis
            bottleNames = [];
            let allFilled = true;
            
            for (let i = 1; i <= bottleCount; i++) {
                const nameInput = document.getElementById(`bottle-name-${i}`);
                const name = nameInput.value.trim();
                
                if (!name) {
                    allFilled = false;
                    nameInput.style.borderColor = '#F44336';
                } else {
                    nameInput.style.borderColor = '';
                    bottleNames.push({ id: i, name: name });
                }
            }
            
            if (!allFilled) {
                alert('Veuillez nommer toutes les bouteilles');
                return;
            }
            
            setupBottleSelection();
            showScreen('bottle-selection');
        }

        function setupBottleSelection() {
            const container = document.getElementById('bottle-selection-container');
            container.innerHTML = '';
            
            bottleNames.forEach(bottle => {
                const option = document.createElement('div');
                option.className = 'choice-option';
                option.onclick = () => selectBottle(bottle.id, bottle.name);
                
                option.innerHTML = `
                    <div class="choice-content">
                        <div class="choice-title">🍷 ${bottle.name}</div>
                        <div class="choice-desc">Bouteille ${bottle.id}</div>
                    </div>
                `;
                
                container.appendChild(option);
            });
        }

        function selectBottle(id, name) {
            // Désélectionner toutes les options
            document.querySelectorAll('.choice-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Sélectionner l'option cliquée
            event.currentTarget.classList.add('selected');
            selectedBottleId = name;
        }

        function goToBottleSetup() {
            showScreen('bottle-setup');
        }

        function goToBottleNaming() {
            showScreen('bottle-naming');
        }

        function startTastingQuestions() {
            // Vérifier qu'une bouteille est sélectionnée pour les multi-bouteilles
            if (bottleCount > 1 && !selectedBottleId) {
                alert('Veuillez sélectionner une bouteille à déguster');
                return;
            }
            
            // Initialiser les données de session multi-bouteilles
            if (bottleCount > 1) {
                currentBottleIndex = 0;
                completedBottles = [];
            }
            
            resetAnswers();
            currentQuestionIndex = 0;
            showScreen('tasting-questions');
            displayCurrentQuestion();
            updateBottleProgress();
        }

        function displayCurrentQuestion() {
            const question = questions[currentQuestionIndex];
            
            document.getElementById('current-question').textContent = (currentQuestionIndex + 1) + ' / ' + questions.length;
            document.getElementById('question-title').textContent = question.icon + ' ' + question.title;
            document.getElementById('question-subtitle').textContent = question.subtitle;
            
            // Afficher l'identifiant de la bouteille en cours
            const bottleIdEl = document.getElementById('current-bottle-id');
            if (bottleIdEl && bottleCount > 1) {
                bottleIdEl.textContent = `${selectedBottleId || `Bouteille ${currentBottleIndex + 1}`}`;
                bottleIdEl.style.display = 'block';
            } else if (bottleIdEl) {
                bottleIdEl.style.display = 'none';
            }
            
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.style.display = currentQuestionIndex > 0 ? 'inline-flex' : 'none';
            
            // Gestion du texte du bouton selon le contexte
            if (currentQuestionIndex === questions.length - 1) {
                if (bottleCount > 1 && currentBottleIndex < bottleCount - 1) {
                    nextBtn.textContent = 'Bouteille suivante';
                } else {
                    nextBtn.textContent = 'Terminer';
                }
            } else {
                nextBtn.textContent = 'Suivant';
            }
            
            nextBtn.disabled = !answers[currentQuestionIndex];
            
            loadAnswerInterface(question);
            updateProgressBar('tasting-questions');
            
            // Update bottle progress for multi-bottle tastings
            updateBottleProgress();
        }

        function loadAnswerInterface(question) {
            const container = document.getElementById('answer-container');
            container.innerHTML = '';
            
            if (question.type === 'rating') {
                const ratingDiv = document.createElement('div');
                ratingDiv.className = 'rating-scale';
                
                for (let i = 1; i <= 5; i++) {
                    const button = document.createElement('button');
                    button.className = 'rating-btn';
                    button.textContent = i;
                    button.onclick = () => selectRating(i);
                    ratingDiv.appendChild(button);
                }
                
                container.appendChild(ratingDiv);
            } else if (question.type === 'choice') {
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'choice-options';
                
                question.options.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'choice-option';
                    optionDiv.onclick = () => selectChoice(option);
                    
                    optionDiv.innerHTML = 
                        '<div class="choice-title">' + option.title + '</div>' +
                        '<div class="choice-desc">' + option.desc + '</div>';
                    
                    choicesDiv.appendChild(optionDiv);
                });
                
                container.appendChild(choicesDiv);
            }
        }

        function selectRating(rating) {
            document.querySelectorAll('.rating-btn').forEach((btn, index) => {
                btn.classList.toggle('selected', index + 1 === rating);
            });
            
            answers[currentQuestionIndex] = { type: 'rating', value: rating };
            document.getElementById('next-btn').disabled = false;
            
            setTimeout(() => {
                if (!document.getElementById('next-btn').disabled) {
                    nextQuestion();
                }
            }, 800);
        }

        function selectChoice(option) {
            document.querySelectorAll('.choice-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            answers[currentQuestionIndex] = { type: 'choice', option: option, value: option.value };
            document.getElementById('next-btn').disabled = false;
            
            setTimeout(() => {
                if (!document.getElementById('next-btn').disabled) {
                    nextQuestion();
                }
            }, 800);
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                // Choisir la fonction d'affichage selon le mode
                if (currentSession) {
                    displayCurrentQuestionForSession();
                } else {
                    displayCurrentQuestion();
                }
            } else {
                if (currentSession) {
                    finishSessionBottle();
                } else {
                    finishTasting();
                }
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                // Choisir la fonction d'affichage selon le mode
                if (currentSession) {
                    displayCurrentQuestionForSession();
                } else {
                    displayCurrentQuestion();
                }
            }
        }

        function skipQuestion() {
            answers[currentQuestionIndex] = null;
            nextQuestion();
        }

        let currentTastingData = null; // Stockage temporaire
        let currentBottleIndex = 0; // Index de la bouteille en cours
        let completedBottles = []; // Bouteilles terminées

        async function finishTasting() {
            const finalScore = calculateFinalScore();
            const answeredQuestions = answers.filter(a => a !== null && a !== undefined).length;
            
            // Stocker les données pour sauvegarde ultérieure
            currentTastingData = {
                finalScore,
                answeredQuestions,
                answers: answers.map((answer, index) => ({
                    questionId: questions[index]?.id,
                    type: answer?.type || 'rating',
                    value: answer?.value,
                    text: answer?.text
                })).filter(a => a.value)
            };
            
            // Si c'est une dégustation multi-bouteilles
            if (bottleCount > 1) {
                // Sauvegarder la bouteille actuelle
                const bottleData = {
                    bottleId: selectedBottleId || `Bouteille ${currentBottleIndex + 1}`,
                    ...currentTastingData
                };
                completedBottles.push(bottleData);
                
                // Passer à la bouteille suivante
                if (currentBottleIndex < bottleCount - 1) {
                    currentBottleIndex++;
                    proceedToNextBottle();
                    return;
                }
                
                // Toutes les bouteilles sont terminées
                displayMultiBottleResults();
                
                // Programmer le retour au menu après un délai
                setTimeout(() => {
                    alert('Toutes les dégustations terminées !\\nRetour au menu principal...');
                    resetTasting();
                    showScreen('dashboard');
                }, 3000);
            } else {
                displayResults(finalScore, answeredQuestions);
            }
            
            showScreen('results');
        }

        function calculateFinalScore() {
            let totalScore = 0;
            let answeredQuestions = 0;
            
            answers.forEach(answer => {
                if (answer && answer.value) {
                    totalScore += (answer.value / 5.0) * 4.0;
                    answeredQuestions++;
                }
            });
            
            return answeredQuestions > 0 ? totalScore : 0;
        }

        function displayResults(finalScore, answeredQuestions) {
            currentFinalScore = finalScore;
            document.getElementById('final-score').textContent = finalScore.toFixed(1) + '/20';
            document.getElementById('score-description').textContent = getScoreDescription(finalScore);
            document.getElementById('answered-questions').textContent = answeredQuestions + '/' + questions.length;
            document.getElementById('tasting-date').textContent = new Date().toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // L'identifiant est déjà défini dans selectedBottleId
        }


        function getScoreDescription(score) {
            if (score >= 18) return 'Vin exceptionnel ! 🌟';
            if (score >= 16) return 'Très bon vin ! 🍷';
            if (score >= 14) return 'Bon vin ✨';
            if (score >= 12) return 'Vin correct 👍';
            if (score >= 10) return 'Vin moyen 😐';
            return 'Vin décevant 😞';
        }

        async function saveTastingResult(score, answeredQuestions) {
            try {
                const tastingData = {
                    bottleCount: bottleCount,
                    finalScore: score,
                    answeredQuestions: answeredQuestions,
                    answers: answers.map((answer, index) => ({
                        questionId: questions[index]?.id,
                        type: answer?.type || 'rating',
                        value: answer?.value,
                        text: answer?.text
                    })).filter(a => a.value)
                };
                
                setLoading(true);
                await api.createTasting(tastingData);
                await loadUserStatistics();
                setLoading(false);
            } catch (error) {
                setLoading(false);
                console.error('Erreur lors de la sauvegarde:', error);
                showError('Erreur lors de la sauvegarde de la dégustation');
            }
        }

        async function saveTastingWithWineInfo() {
            try {
                // Utiliser le score stocké globalement
                const finalScore = currentFinalScore;
                const answeredQuestions = answers.filter(a => a && a.value).length;
                
                // Utiliser l'identifiant de bouteille sélectionné
                const bottleIdentifier = selectedBottleId;
                const wineName = document.getElementById('wine-name').value.trim() || null;
                const wineVintage = document.getElementById('wine-vintage').value.trim() || null;
                const wineRegion = document.getElementById('wine-region').value.trim() || null;
                const wineType = document.getElementById('wine-type').value || null;
                const notes = document.getElementById('wine-notes').value.trim() || null;
                
                const tastingData = {
                    bottleCount: bottleCount,
                    finalScore: finalScore,
                    answeredQuestions: answeredQuestions,
                    answers: answers.map((answer, index) => ({
                        questionId: questions[index]?.id,
                        type: answer?.type || 'rating',
                        value: answer?.value,
                        text: answer?.text
                    })).filter(a => a.value),
                    bottleIdentifier: bottleIdentifier,
                    wineName: wineName,
                    wineVintage: wineVintage ? parseInt(wineVintage) : null,
                    wineRegion: wineRegion,
                    wineType: wineType,
                    notes: notes
                };
                
                setLoading(true);
                await api.createTasting(tastingData);
                await loadUserStatistics();
                setLoading(false);
                
                // Afficher un message de succès et retourner au menu principal
                showSuccess('Dégustation sauvegardée avec succès !');
                setTimeout(() => {
                    goToMain();
                }, 1500);
                
            } catch (error) {
                setLoading(false);
                console.error('Erreur lors de la sauvegarde:', error);
                showError('Erreur lors de la sauvegarde de la dégustation');
            }
        }

        async function updateHistoryDisplay() {
            try {
                setLoading(true);
                // Si l'utilisateur est arbitre, utiliser l'endpoint admin
                // Pour les testeurs, récupérer toutes les dégustations (limite élevée)
                const response = api.isArbitre() ? 
                    await api.getAllTastings() : 
                    await api.getTastings(1, 1000);
                const tastings = response.data.tastings;
                const historyList = document.getElementById('history-list');
                
                if (tastings.length === 0) {
                    historyList.innerHTML = 
                        '<div class="empty-state">' +
                            '<div class="empty-icon">🍷</div>' +
                            '<h3>Aucune dégustation enregistrée</h3>' +
                            '<p>Participez à une session de dégustation pour voir vos résultats ici</p>' +
                        '</div>';
                    setLoading(false);
                    return;
                }
                
                const totalScore = tastings.reduce((sum, t) => sum + t.finalScore, 0);
                const averageScore = totalScore / tastings.length;
                const plural = tastings.length > 1 ? 's' : '';
                
                document.getElementById('history-stats').textContent = 
                    tastings.length + ' dégustation' + plural + ' • Note moyenne: ' + averageScore.toFixed(1) + '/20';
                
                historyList.innerHTML = '';
                
                tastings.forEach(tasting => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    
                    const date = new Date(tasting.tastingDate);
                    const formattedDate = date.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Informations utilisateur pour l'arbitre
                    const userInfo = api.isArbitre() && tasting.user ? 
                        '<div class="history-user">👤 ' + tasting.user.firstName + ' ' + tasting.user.lastName + ' (' + tasting.user.username + ')</div>' : '';
                    
                    // Informations sur le vin avec identifiant de bouteille
                    const bottleId = tasting.bottleIdentifier ? tasting.bottleIdentifier + ' • ' : '';
                    const wineName = tasting.wine?.name || 'Vin dégusté';
                    const wineVintage = tasting.wine?.vintage ? ' (' + tasting.wine.vintage + ')' : '';
                    const wineRegion = tasting.wine?.region && tasting.wine.region !== 'Non spécifiée' ? ' - ' + tasting.wine.region : '';
                    const wineInfo = '<div class="history-wine">🍷 ' + bottleId + wineName + wineVintage + wineRegion + '</div>';
                    
                    item.innerHTML = 
                        '<div class="history-header">' +
                            '<div class="history-score">' + tasting.finalScore.toFixed(1) + '/20</div>' +
                            '<div class="history-date">' + formattedDate + '</div>' +
                        '</div>' +
                        userInfo +
                        wineInfo +
                        '<div class="history-description">' + getScoreDescription(tasting.finalScore) + '</div>';
                    
                    historyList.appendChild(item);
                });
                
                setLoading(false);
            } catch (error) {
                setLoading(false);
                console.error('Erreur lors du chargement de l\'historique:', error);
                showError('Erreur lors du chargement de l\'historique');
            }
        }

        async function updateRankingsDisplay() {
            try {
                setLoading(true);
                
                console.log('🏆 Mise à jour du classement des bouteilles par note finale...');
                
                // Récupérer toutes les dégustations
                const tastingsResponse = api.isArbitre() ? 
                    await api.getAllTastings() : 
                    await api.getTastings(1, 1000);
                
                const tastings = tastingsResponse.data.tastings || [];
                console.log('📊 Dégustations récupérées:', tastings.length);
                
                if (tastings.length === 0) {
                    const rankingsList = document.getElementById('rankings-list');
                    const rankingsStats = document.getElementById('rankings-stats');
                    
                    rankingsList.innerHTML = 
                        '<div class="empty-state">' +
                            '<div class="empty-icon">🍷</div>' +
                            '<h3>Aucune dégustation</h3>' +
                            '<p>Commencez à déguster des bouteilles pour voir le classement</p>' +
                        '</div>';
                    rankingsStats.textContent = 'Classement des bouteilles par note finale (ordre décroissant)';
                    setLoading(false);
                    return;
                }
                
                // Grouper les dégustations par bouteille
                const bottleStats = {};
                
                tastings.forEach(tasting => {
                    // Utiliser le nom du vin comme clé principale
                    const bottleKey = tasting.wine?.name || tasting.wineName || 'Vin inconnu';
                    const bottleId = tasting.bottleIdentifier || tasting.bottle_identifier || bottleKey;
                    
                    if (!bottleStats[bottleKey]) {
                        bottleStats[bottleKey] = {
                            bottleIdentifier: bottleId,
                            wine: {
                                name: tasting.wine?.name || tasting.wineName || 'Vin inconnu',
                                vintage: tasting.wine?.vintage || tasting.wineVintage || null,
                                region: tasting.wine?.region || tasting.wineRegion || 'Non spécifiée',
                                type: tasting.wine?.type || tasting.wineType || 'Non spécifié'
                            },
                            scores: [],
                            totalScore: 0,
                            tastingCount: 0,
                            lastTastingDate: tasting.tastingDate
                        };
                    }
                    
                    const score = parseFloat(tasting.finalScore) || 0;
                    bottleStats[bottleKey].scores.push(score);
                    bottleStats[bottleKey].totalScore += score;
                    bottleStats[bottleKey].tastingCount++;
                    
                    // Garder la date de dégustation la plus récente
                    if (tasting.tastingDate > bottleStats[bottleKey].lastTastingDate) {
                        bottleStats[bottleKey].lastTastingDate = tasting.tastingDate;
                    }
                });
                
                // Créer le classement trié par note finale moyenne décroissante
                const bottleRankings = Object.values(bottleStats)
                    .map(bottle => ({
                        ...bottle,
                        averageScore: bottle.totalScore / bottle.tastingCount,
                        bestScore: Math.max(...bottle.scores),
                        worstScore: Math.min(...bottle.scores),
                        finalScore: bottle.totalScore / bottle.tastingCount // Note finale = moyenne
                    }))
                    .sort((a, b) => b.finalScore - a.finalScore); // Tri par note finale décroissante
                
                console.log('🏆 Classement créé:', bottleRankings.length, 'bouteilles triées par note finale');
                
                const rankingsList = document.getElementById('rankings-list');
                const rankingsStats = document.getElementById('rankings-stats');
                
                // Mettre à jour les statistiques
                const totalBottles = bottleRankings.length;
                const totalTastings = bottleRankings.reduce((sum, bottle) => sum + bottle.tastingCount, 0);
                rankingsStats.textContent = `${totalBottles} bouteille${totalBottles > 1 ? 's' : ''} classée${totalBottles > 1 ? 's' : ''} sur ${totalTastings} dégustation${totalTastings > 1 ? 's' : ''}`;
                
                rankingsList.innerHTML = '';
                
                // Affichage du classement global des bouteilles
                bottleRankings.forEach((bottle, index) => {
                    const item = document.createElement('div');
                    item.className = 'ranking-item bottle-ranking';
                    
                    // Classes spéciales pour le podium
                    let rankClass = '';
                    if (index === 0) rankClass = ' gold';
                    else if (index === 1) rankClass = ' silver';
                    else if (index === 2) rankClass = ' bronze';
                    
                    // Formatage des informations du vin
                    const wineName = bottle.wine?.name || 'Vin inconnu';
                    const wineVintage = bottle.wine?.vintage ? ` (${bottle.wine.vintage})` : '';
                    const wineRegion = bottle.wine?.region && bottle.wine.region !== 'Non spécifiée' ? ` - ${bottle.wine.region}` : '';
                    const wineType = bottle.wine?.type && bottle.wine.type !== 'Non spécifié' ? ` • ${bottle.wine.type}` : '';
                    
                    // Formatage de la date de dernière dégustation
                    const lastTasting = bottle.lastTastingDate ? new Date(bottle.lastTastingDate).toLocaleDateString('fr-FR') : '';
                    
                    item.innerHTML = `
                        <div class="rank-position${rankClass}">
                            <span class="rank-number">${index + 1}</span>
                        </div>
                        <div class="ranking-content">
                            <div class="ranking-wine">🍷 ${wineName}${wineVintage}${wineRegion}${wineType}</div>
                            <div class="ranking-stats">
                                <div class="stat-item primary">
                                    <span class="stat-value">${bottle.finalScore.toFixed(1)}/20</span>
                                    <span class="stat-label">Note Finale</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${bottle.bestScore.toFixed(1)}/20</span>
                                    <span class="stat-label">Meilleure</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">${bottle.tastingCount}</span>
                                    <span class="stat-label">Dégustation${bottle.tastingCount > 1 ? 's' : ''}</span>
                                </div>
                                ${lastTasting ? `<div class="stat-item"><span class="stat-value">${lastTasting}</span><span class="stat-label">Dernière</span></div>` : ''}
                            </div>
                        </div>
                    `;
                    rankingsList.appendChild(item);
                });
                
                setLoading(false);
            } catch (error) {
                setLoading(false);
                console.error('Erreur lors du chargement du classement:', error);
                showError('Erreur lors du chargement du classement');
            }
        }

        // Ajout des styles CSS pour les nouveaux éléments de classement
        function addRankingStyles() {
            const style = document.createElement('style');
            style.textContent = `
                .session-ranking-header {
                    margin: 24px 0 16px 0;
                    padding: 16px;
                    background: var(--wine-accent-light);
                    border-radius: 12px;
                    border-left: 4px solid var(--wine-primary);
                }

                .session-ranking-header h3 {
                    margin: 0 0 8px 0;
                    color: var(--wine-primary);
                    font-size: 1.2rem;
                }

                .session-type {
                    margin: 0;
                    color: var(--text-secondary);
                    font-size: 14px;
                }

                .participant-ranking .participant-name {
                    font-size: 1.1rem;
                    font-weight: 600;
                    color: var(--text-primary);
                    margin-bottom: 8px;
                }

                .participant-stats, .ranking-stats {
                    display: flex;
                    gap: 16px;
                    flex-wrap: wrap;
                }

                .rank-position.gold {
                    background: linear-gradient(135deg, #ffd700, #ffed4e);
                    color: #b8860b;
                }

                .rank-position.silver {
                    background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
                    color: #696969;
                }

                .rank-position.bronze {
                    background: linear-gradient(135deg, #cd7f32, #daa520);
                    color: #8b4513;
                }
            `;
            document.head.appendChild(style);
        }

        // Appeler la fonction d'ajout des styles au chargement
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', addRankingStyles);
        } else {
            addRankingStyles();
        }

        async function resetData() {
            // Première confirmation détaillée
            if (confirm('⚠️ ATTENTION - SUPPRESSION DÉFINITIVE ⚠️\n\nÊtes-vous sûr de vouloir effacer toutes les données ?\n\nCette action supprimera DÉFINITIVEMENT :\n• Toutes les dégustations et leurs notes\n• Toutes les sessions de dégustation\n• Toutes les bouteilles configurées\n• Tous les participants (sauf le compte arbitre)\n• Tout l\'historique des dégustations\n• Toutes les statistiques\n\n⚠️ CETTE ACTION EST IRRÉVERSIBLE ⚠️\n\nContinuer ?')) {
                
                // Seconde confirmation de sécurité
                if (confirm('🚨 DERNIÈRE CONFIRMATION 🚨\n\nVous êtes sur le point de SUPPRIMER DÉFINITIVEMENT toutes les données de l\'application.\n\nIl sera IMPOSSIBLE de récupérer ces données après cette action.\n\nConfirmez-vous vraiment cette suppression complète ?')) {
                    try {
                        setLoading(true);
                        console.log('🗑️ Début de la suppression complète des données...');
                        
                        // Utiliser l'endpoint optimisé qui gère toutes les suppressions
                        await api.resetAllData();
                        
                        console.log('✅ Toutes les données ont été supprimées');
                        
                        // Actualiser les affichages si on est sur ces pages
                        if (document.getElementById('history').style.display !== 'none') {
                            await updateHistoryDisplay();
                        }
                        if (document.getElementById('rankings').style.display !== 'none') {
                            await updateRankingsDisplay();
                        }
                        
                        setLoading(false);
                        showSuccess('🗑️ Toutes les données ont été effacées avec succès.');
                        console.log('✅ Suppression complète terminée');
                        
                    } catch (error) {
                        setLoading(false);
                        console.error('❌ Erreur lors de la suppression:', error);
                        showError('Erreur lors de la suppression des données: ' + (error.message || 'Erreur inconnue'));
                    }
                }
            }
        }

        // === GESTION DES DÉGUSTATIONS POUR PARTICIPANTS ===
        
        // Initialiser l'affichage du menu selon le rôle
        function initializeMenuByRole() {
            console.log('🔧 initializeMenuByRole() appelée');
            
            // Vérifier le rôle de l'utilisateur
            if (api && !api.isArbitre()) {
                // Utilisateur testeur : afficher le bouton Dégustations
                console.log('👤 Utilisateur testeur détecté - Affichage bouton Dégustations');
                const tastingsCard = document.getElementById('tastings-card');
                if (tastingsCard) {
                    tastingsCard.style.display = 'block';
                }
            } else {
                // Utilisateur arbitre : masquer le bouton Dégustations
                console.log('🔧 Utilisateur arbitre détecté - Masquage bouton Dégustations');
                const tastingsCard = document.getElementById('tastings-card');
                if (tastingsCard) {
                    tastingsCard.style.display = 'none';
                }
            }
        }
        
        // Afficher les sessions actives disponibles pour dégustation
        async function showTastingsSessions() {
            console.log('🍷 showTastingsSessions() appelée');
            
            if (!api || api.isArbitre()) {
                showError('Cette fonction est réservée aux participants');
                return;
            }
            
            try {
                setLoading(true);
                
                // Récupérer les sessions actives
                const response = await api.getAvailableSessions();
                console.log('📋 Sessions disponibles:', response);
                
                if (response.success && response.data && response.data.length > 0) {
                    // Afficher l'écran de sélection des sessions
                    displayAvailableSessions(response.data);
                    showScreen('tasting-sessions');
                } else {
                    showError('Aucune session de dégustation active disponible');
                }
                
                setLoading(false);
            } catch (error) {
                setLoading(false);
                console.error('❌ Erreur récupération sessions:', error);
                showError('Erreur lors de la récupération des sessions: ' + (error.message || 'Erreur inconnue'));
            }
        }
        
        // Afficher la liste des sessions disponibles
        function displayAvailableSessions(sessions) {
            console.log('📋 displayAvailableSessions() - Sessions:', sessions);
            
            let html = `
                <div class="tasting-sessions-list">
                    <h2>🍷 Sessions de dégustation actives</h2>
                    <div class="sessions-grid">
            `;
            
            sessions.forEach(session => {
                html += `
                    <div class="session-card" onclick="joinTastingSession(${session.id})">
                        <div class="session-header">
                            <h3>${session.name}</h3>
                            <span class="session-status">Actif</span>
                        </div>
                        <div class="session-info">
                            <p>📊 Type: ${session.type === 'blind' ? 'Dégustation à l\'aveugle' : 'Dégustation standard'}</p>
                            <p>🍾 Bouteilles: ${session.bottle_count || 0}</p>
                        </div>
                        <div class="session-actions">
                            <button class="btn-primary">Rejoindre</button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div class="navigation-buttons">
                        <button class="btn-secondary" onclick="goToMain()">Retour au menu</button>
                    </div>
                </div>
            `;
            
            // Injecter dans l'écran tasting-sessions (que nous créerons)
            document.getElementById('tasting-sessions-content').innerHTML = html;
        }
        
        // Rejoindre une session de dégustation
        async function joinTastingSession(sessionId) {
            console.log('🎯 joinTastingSession() - Session ID:', sessionId);
            
            try {
                setLoading(true);
                
                // Rejoindre la session
                const joinResponse = await api.joinSession(sessionId);
                console.log('✅ Join response:', joinResponse);
                
                if (joinResponse.success) {
                    // Récupérer les détails de la session pour le testeur
                    const sessionResponse = await api.getSessionForTaster(sessionId);
                    console.log('📋 Session détails:', sessionResponse);
                    
                    if (sessionResponse.success) {
                        // Démarrer la dégustation séquentielle
                        startSequentialTasting(sessionResponse.data);
                    } else {
                        showError('Erreur lors de la récupération des détails de la session');
                    }
                } else {
                    showError('Erreur lors de l\'adhésion à la session: ' + (joinResponse.message || 'Erreur inconnue'));
                }
                
                setLoading(false);
            } catch (error) {
                setLoading(false);
                console.error('❌ Erreur join session:', error);
                showError('Erreur lors de l\'adhésion: ' + (error.message || 'Erreur inconnue'));
            }
        }
        
        // Démarrer la dégustation séquentielle des bouteilles
        function startSequentialTasting(sessionData) {
            console.log('🎯 startSequentialTasting() - Session:', sessionData);
            
            const session = sessionData.session;
            const bottles = sessionData.bottles;
            const userSession = sessionData.userSession;
            
            if (!bottles || bottles.length === 0) {
                showError('Aucune bouteille disponible dans cette session');
                return;
            }
            
            // Stocker les données globalement pour la dégustation
            window.currentTastingSession = {
                session,
                bottles,
                userSession,
                currentBottleIndex: userSession.current_bottle - 1 || 0,
                tastingResults: []
            };
            
            // Afficher l'écran de dégustation
            displayBottleTasting();
            showScreen('bottle-tasting');
        }
        
        // Afficher l'interface de dégustation de la bouteille courante
        function displayBottleTasting() {
            const tastingData = window.currentTastingSession;
            if (!tastingData || !tastingData.bottles) {
                showError('Données de dégustation non disponibles');
                return;
            }
            
            const currentBottle = tastingData.bottles[tastingData.currentBottleIndex];
            const progress = ((tastingData.currentBottleIndex) / tastingData.bottles.length) * 100;
            
            // Mettre à jour la barre de progression
            document.getElementById('tasting-progress').style.width = progress + '%';
            
            let html = `
                <div class="bottle-tasting-interface">
                    <div class="tasting-header">
                        <div class="session-info">
                            <h3>🍷 ${tastingData.session.name}</h3>
                            <p>Bouteille ${tastingData.currentBottleIndex + 1} sur ${tastingData.bottles.length}</p>
                        </div>
                        <div class="bottle-counter">
                            <span class="current-bottle">${currentBottle.bottle_number}</span>
                        </div>
                    </div>
                    
                    <div class="bottle-details">
                        <h2>🍾 ${currentBottle.custom_name}</h2>
                        ${currentBottle.wine_details ? '<p class="wine-details">' + currentBottle.wine_details + '</p>' : ''}
                    </div>
                    
                    <form id="bottle-tasting-form" onsubmit="submitBottleTasting(event)">
                        <div class="tasting-questions">
                            <div class="question-group">
                                <label for="visual-rating">👁️ Aspect visuel</label>
                                <div class="rating-group">
                                    <input type="range" id="visual-rating" name="visual" min="0" max="20" value="10" onchange="updateRatingValue(this)">
                                    <span class="rating-value">10/20</span>
                                </div>
                            </div>
                            
                            <div class="question-group">
                                <label for="nose-rating">👃 Nez (arômes)</label>
                                <div class="rating-group">
                                    <input type="range" id="nose-rating" name="nose" min="0" max="20" value="10" onchange="updateRatingValue(this)">
                                    <span class="rating-value">10/20</span>
                                </div>
                            </div>
                            
                            <div class="question-group">
                                <label for="taste-rating">👅 Goût</label>
                                <div class="rating-group">
                                    <input type="range" id="taste-rating" name="taste" min="0" max="20" value="10" onchange="updateRatingValue(this)">
                                    <span class="rating-value">10/20</span>
                                </div>
                            </div>
                            
                            <div class="question-group">
                                <label for="finish-rating">🎯 Finale</label>
                                <div class="rating-group">
                                    <input type="range" id="finish-rating" name="finish" min="0" max="20" value="10" onchange="updateRatingValue(this)">
                                    <span class="rating-value">10/20</span>
                                </div>
                            </div>
                            
                            <div class="question-group">
                                <label for="overall-rating">⭐ Note globale</label>
                                <div class="rating-group">
                                    <input type="range" id="overall-rating" name="overall" min="0" max="20" value="10" onchange="updateRatingValue(this)">
                                    <span class="rating-value">10/20</span>
                                </div>
                            </div>
                            
                            <div class="question-group">
                                <label for="wine-type">🍇 Type de vin</label>
                                <select id="wine-type" name="wineType">
                                    <option value="">Sélectionner...</option>
                                    <option value="rouge">Rouge</option>
                                    <option value="blanc">Blanc</option>
                                    <option value="rosé">Rosé</option>
                                    <option value="champagne">Champagne/Crémant</option>
                                    <option value="autre">Autre</option>
                                </select>
                            </div>
                            
                            <div class="question-group">
                                <label for="tasting-notes">📝 Notes de dégustation (optionnel)</label>
                                <textarea id="tasting-notes" name="notes" placeholder="Vos impressions, arômes ressentis, commentaires..."></textarea>
                            </div>
                        </div>
                        
                        <div class="tasting-actions">
                            <button type="submit" class="btn-primary">
                                ${tastingData.currentBottleIndex < tastingData.bottles.length - 1 ? 'Bouteille suivante' : 'Terminer la dégustation'}
                            </button>
                            <button type="button" class="btn-secondary" onclick="goToMain()">Quitter</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('bottle-tasting-content').innerHTML = html;
        }
        
        // Mettre à jour la valeur affichée des ratings
        function updateRatingValue(slider) {
            const valueSpan = slider.parentElement.querySelector('.rating-value');
            valueSpan.textContent = slider.value + '/20';
        }
        
        // Soumettre la dégustation de la bouteille courante
        async function submitBottleTasting(event) {
            event.preventDefault();
            
            const tastingData = window.currentTastingSession;
            if (!tastingData) {
                showError('Données de dégustation non disponibles');
                return;
            }
            
            const form = event.target;
            const formData = new FormData(form);
            
            const currentBottle = tastingData.bottles[tastingData.currentBottleIndex];
            
            // Préparer les données de dégustation
            const tastingResult = {
                bottle_id: currentBottle.id,
                bottle_number: currentBottle.bottle_number,
                bottle_name: currentBottle.custom_name,
                visual: parseInt(formData.get('visual')),
                nose: parseInt(formData.get('nose')),
                taste: parseInt(formData.get('taste')),
                finish: parseInt(formData.get('finish')),
                overall: parseInt(formData.get('overall')),
                wine_type: formData.get('wineType'),
                notes: formData.get('notes') || ''
            };
            
            console.log('📊 Résultat dégustation:', tastingResult);
            
            // Ajouter aux résultats
            tastingData.tastingResults.push(tastingResult);
            
            // Passer à la bouteille suivante ou terminer
            if (tastingData.currentBottleIndex < tastingData.bottles.length - 1) {
                tastingData.currentBottleIndex++;
                displayBottleTasting();
            } else {
                await completeTastingSession();
            }
        }
        
        // Terminer la session de dégustation
        async function completeTastingSession() {
            console.log('🚀 completeTastingSession appelée');
            const tastingData = window.currentTastingSession;
            console.log('📊 Données de session:', tastingData);
            
            if (!tastingData) {
                console.error('❌ Données de dégustation non disponibles');
                showError('Données de dégustation non disponibles');
                return;
            }
            
            console.log('📋 Résultats à sauvegarder:', tastingData.tastingResults);
            
            try {
                console.log('🔄 Début du processus de sauvegarde...');
                setLoading(true);
                
                // Définir les questions correspondant à notre interface
                const questions = [
                    { id: 'visual', type: 'rating' },
                    { id: 'nose', type: 'rating' },
                    { id: 'taste', type: 'rating' },
                    { id: 'finish', type: 'rating' },
                    { id: 'overall', type: 'rating' }
                ];
                
                // Sauvegarder chaque dégustation de bouteille individuellement
                console.log('💾 Sauvegarde des dégustations...');
                let savedCount = 0;
                
                for (const result of tastingData.tastingResults) {
                    try {
                        // Calculer le score total pour cette bouteille
                        const totalScore = result.visual + result.nose + result.taste + result.finish + result.overall;
                        const averageScore = totalScore / 5;
                        
                        // Préparer les données de dégustation selon le format attendu par l'API
                        const tastingApiData = {
                            bottleCount: 1, // Une bouteille par dégustation
                            finalScore: averageScore,
                            answeredQuestions: 5, // Nous avons 5 questions
                            totalScore: averageScore, // Backward compatibility
                            answers: [
                                {
                                    questionId: 'visual',
                                    type: 'rating',
                                    value: result.visual
                                },
                                {
                                    questionId: 'nose',
                                    type: 'rating', 
                                    value: result.nose
                                },
                                {
                                    questionId: 'taste',
                                    type: 'rating',
                                    value: result.taste
                                },
                                {
                                    questionId: 'finish',
                                    type: 'rating',
                                    value: result.finish
                                },
                                {
                                    questionId: 'overall',
                                    type: 'rating',
                                    value: result.overall
                                }
                            ],
                            bottleIdentifier: result.bottle_number.toString(),
                            wineName: result.bottle_name,
                            wineVintage: 2020, // Valeur par défaut valide
                            wineRegion: '',
                            wineType: result.wine_type || '',
                            notes: result.notes || ''
                        };
                        
                        console.log(`💾 Sauvegarde bouteille ${result.bottle_number}:`, tastingApiData);
                        console.log('🔗 API object:', api);
                        console.log('🔧 createTasting function:', typeof api.createTasting);
                        
                        // Sauvegarder via l'API
                        console.log(`📡 Appel API createTasting pour bouteille ${result.bottle_number}...`);
                        const saveResult = await api.createTasting(tastingApiData);
                        console.log(`📈 Résultat API pour bouteille ${result.bottle_number}:`, saveResult);
                        savedCount++;
                        
                        console.log(`✅ Bouteille ${result.bottle_number} sauvegardée`);
                        
                    } catch (error) {
                        console.error(`❌ Erreur sauvegarde bouteille ${result.bottle_number}:`, error);
                        // Continuer avec les autres bouteilles même si une échoue
                    }
                }
                
                console.log(`✅ Sauvegarde terminée: ${savedCount}/${tastingData.tastingResults.length} bouteilles`);
                
                // Calculer la note moyenne globale
                let totalScore = 0;
                tastingData.tastingResults.forEach(result => {
                    totalScore += (result.visual + result.nose + result.taste + result.finish + result.overall);
                });
                const averageScore = totalScore / (tastingData.tastingResults.length * 5);
                
                // Actualiser les statistiques utilisateur
                try {
                    await loadUserStatistics();
                } catch (error) {
                    console.warn('⚠️ Erreur actualisation statistiques:', error);
                }
                
                // Afficher un résumé
                displayTastingResults(tastingData.tastingResults, averageScore, savedCount);
                
                // Nettoyer les données temporaires
                window.currentTastingSession = null;
                
                setLoading(false);
                
                // Retourner au menu après 5 secondes
                setTimeout(() => {
                    goToMain();
                }, 5000);
                
            } catch (error) {
                setLoading(false);
                console.error('❌ Erreur finalisation dégustation:', error);
                showError('Erreur lors de la finalisation: ' + (error.message || 'Erreur inconnue'));
            }
        }
        
        // Afficher les résultats de la dégustation
        function displayTastingResults(results, averageScore, savedCount = 0) {
            let html = `
                <div class="tasting-results">
                    <h2>🎉 Dégustation terminée !</h2>
                    <div class="results-summary">
                        <div class="average-score">
                            <span class="score-label">Note moyenne</span>
                            <span class="score-value">${averageScore.toFixed(1)}/20</span>
                        </div>
                        ${savedCount > 0 ? `<div class="save-status">💾 ${savedCount} dégustation${savedCount > 1 ? 's' : ''} sauvegardée${savedCount > 1 ? 's' : ''}</div>` : ''}
                    </div>
                    
                    <div class="bottles-results">
                        <h3>📊 Récapitulatif par bouteille</h3>
                        <div class="results-list">
            `;
            
            results.forEach((result, index) => {
                const bottleAverage = ((result.visual + result.nose + result.taste + result.finish + result.overall) / 5).toFixed(1);
                html += `
                    <div class="result-item">
                        <div class="bottle-info">
                            <strong>Bouteille ${result.bottle_number} - ${result.bottle_name}</strong>
                        </div>
                        <div class="bottle-scores">
                            <span class="score">👁️ ${result.visual}/20</span>
                            <span class="score">👃 ${result.nose}/20</span>
                            <span class="score">👅 ${result.taste}/20</span>
                            <span class="score">🎯 ${result.finish}/20</span>
                            <span class="score total">⭐ ${result.overall}/20</span>
                            <span class="average">Moyenne: ${bottleAverage}/20</span>
                        </div>
                        ${result.notes ? '<div class="bottle-notes">' + result.notes + '</div>' : ''}
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                    
                    <div class="results-actions">
                        <p>Retour au menu dans 5 secondes...</p>
                        <button class="btn-primary" onclick="goToMain()">Retour au menu maintenant</button>
                    </div>
                </div>
            `;
            
            document.getElementById('bottle-tasting-content').innerHTML = html;
        }

        // Fonction pour gérer la configuration de mot de passe
        async function setupUserPassword() {
            console.log('🔧 setupUserPassword() appelée');
            
            const emailEl = document.getElementById('setup-email');
            const passwordEl = document.getElementById('setup-password');
            const confirmEl = document.getElementById('setup-password-confirm');
            
            const email = emailEl.value.trim();
            const password = passwordEl.value.trim();
            const confirm = confirmEl.value.trim();
            
            // Validation
            if (!email || !password || !confirm) {
                showError('Veuillez remplir tous les champs', 'setup-error');
                return;
            }
            
            if (password.length < 8) {
                showError('Le mot de passe doit contenir au moins 8 caractères', 'setup-error');
                return;
            }
            
            if (password !== confirm) {
                showError('Les mots de passe ne correspondent pas', 'setup-error');
                return;
            }
            
            try {
                // Fonction setLoading temporaire si elle n'existe pas encore
                if (typeof setLoading !== 'function') {
                    window.setLoading = function(loading) {
                        console.log('📡 Setup Loading:', loading);
                        // Optionnel: ajouter un indicateur visuel
                        const button = document.querySelector('#setup-password-screen button[onclick="setupUserPassword()"]');
                        if (button) {
                            button.disabled = loading;
                            button.textContent = loading ? 'Configuration...' : 'Configurer le mot de passe';
                        }
                    };
                }
                
                setLoading(true);
                
                // Récupérer le token depuis l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                if (!token) {
                    showError('Token manquant dans l\'URL', 'setup-error');
                    setLoading(false);
                    return;
                }
                
                // Configuration de l'URL API (même logique que dans api.js)
                const hostname = window.location.hostname;
                let apiBaseURL;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    apiBaseURL = 'http://localhost:3000/api';
                } else if (hostname === '192.168.1.16') {
                    apiBaseURL = 'http://192.168.1.16:3000/api';
                } else {
                    apiBaseURL = `http://${hostname}:3000/api`;
                }
                
                console.log('🔧 URL API pour setup:', `${apiBaseURL}/auth/setup-password`);
                
                // Appel API pour configurer le mot de passe
                const response = await fetch(`${apiBaseURL}/auth/setup-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        email: email,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Mot de passe configuré avec succès ! Connexion automatique...');
                    
                    // Connexion automatique après configuration réussie
                    setTimeout(async () => {
                        try {
                            const loginResponse = await fetch(`${apiBaseURL}/auth/login`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    email: email,
                                    password: password
                                })
                            });
                            
                            const loginData = await loginResponse.json();
                            
                            if (loginData.success) {
                                // Sauvegarder le token et rediriger
                                localStorage.setItem('wine_tasting_token', loginData.data.token);
                                localStorage.setItem('wine_tasting_user', JSON.stringify(loginData.data.user));
                                
                                showSuccess('Connexion réussie ! Redirection...');
                                
                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 1000);
                            } else {
                                showSuccess('Mot de passe configuré ! Veuillez vous connecter manuellement.');
                                setTimeout(() => {
                                    window.location.href = '/';
                                }, 2000);
                            }
                        } catch (error) {
                            console.error('❌ Erreur connexion auto:', error);
                            showSuccess('Mot de passe configuré ! Veuillez vous connecter manuellement.');
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 2000);
                        }
                    }, 1000);
                } else {
                    showError(data.message || 'Erreur lors de la configuration', 'setup-error');
                }
                
            } catch (error) {
                console.error('❌ Erreur setup password:', error);
                showError('Erreur de connexion au serveur', 'setup-error');
            } finally {
                setLoading(false);
            }
        }

        // Fonction pour détecter si on est sur la page de setup
        function checkPasswordSetup() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            
            if (token && email) {
                console.log('🔧 Page de setup détectée');
                console.log('🔧 Token:', token.substring(0, 8) + '...');
                console.log('🔧 Email:', email);
                
                // Attendre que le DOM soit prêt
                setTimeout(() => {
                    // Afficher l'écran de setup
                    showScreen('setup-password-screen');
                    // Pré-remplir l'email
                    const emailField = document.getElementById('setup-email');
                    if (emailField) {
                        emailField.value = decodeURIComponent(email);
                        console.log('🔧 Email pré-rempli:', decodeURIComponent(email));
                    }
                }, 100);
                
                return true;
            }
            
            return false;
        }

        // Modifier la fonction checkAuthentication
        const originalCheckAuthentication = checkAuthentication;
        function checkAuthentication() {
            // Vérifier d'abord si c'est une page de setup
            if (checkPasswordSetup()) {
                return;
            }
            
            // Sinon, procédure normale
            originalCheckAuthentication();
        }

        // === DASHBOARD TESTEURS ===
        
        // Fonction pour charger les données des testeurs
        async function loadTesterSessions() {
            console.log('🔧 loadTesterSessions() appelée');
            
            try {
                setLoading(true);
                
                // Récupérer l'utilisateur actuel
                const currentUser = getCurrentUser();
                if (!currentUser) {
                    showError('Utilisateur non trouvé');
                    return;
                }
                
                // Mettre à jour le nom du testeur
                document.getElementById('tester-name').textContent = currentUser.first_name || currentUser.username;
                
                // Charger les sessions disponibles pour ce testeur
                const response = await api.getAvailableSessions();
                console.log('📡 Réponse sessions testeur:', response);
                
                if (response.success) {
                    displayTesterSessions(response.data);
                    // Activer l'onglet sessions par défaut
                    showTesterTab('sessions');
                } else {
                    showError('Erreur: ' + (response.message || 'Erreur lors du chargement des sessions'));
                }
                
            } catch (error) {
                console.error('❌ Erreur chargement sessions testeur:', error);
                showError('Erreur lors du chargement: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        // Fonction pour basculer entre les onglets du testeur
        function showTesterTab(tabName) {
            console.log('🔧 showTesterTab:', tabName);
            
            // Cacher tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Afficher l'onglet sélectionné
            document.getElementById(`tester-${tabName}-tab`).classList.add('active');
            document.getElementById(`my-${tabName}-tab`).classList.add('active');
            
            // Charger les données appropriées
            switch(tabName) {
                case 'sessions':
                    // Déjà chargé
                    break;
                case 'tastings':
                    loadTesterTastings();
                    break;
                case 'rankings':
                    loadTesterRankings();
                    break;
            }
        }
        
        // Afficher les sessions du testeur
        function displayTesterSessions(sessions) {
            console.log('🍷 Affichage sessions testeur:', sessions);
            
            const listEl = document.getElementById('tester-sessions-list');
            listEl.innerHTML = '';
            
            if (!sessions || sessions.length === 0) {
                listEl.innerHTML = '<p class="no-data">Aucune session active disponible</p>';
                return;
            }
            
            sessions.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'session-item';
                sessionEl.innerHTML = `
                    <div class="session-display">
                        <div class="session-line-1">
                            <strong>${session.name}</strong>
                        </div>
                        <div class="session-line-2">
                            Type: ${session.type || 'standard'}
                        </div>
                        <div class="session-line-3">
                            Créée le ${new Date(session.created_at).toLocaleDateString('fr-FR')}
                        </div>
                        <div class="session-line-4">
                            Statut: ${session.status || 'setup'} • ${session.bottle_count || 0} bouteille(s)
                        </div>
                        <div class="session-line-5">
                            <div class="session-actions-inline">
                                <button class="btn-primary btn-small" onclick="joinTesterSession(${session.id})">
                                    <span class="icon">🍷</span>
                                    Rejoindre
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(sessionEl);
            });
        }
        
        // Fonction pour rejoindre une session (testeur)
        async function joinTesterSession(sessionId) {
            console.log('🔧 joinTesterSession:', sessionId);
            
            try {
                setLoading(true);
                const response = await api.joinSession(sessionId);
                
                if (response.success) {
                    showSuccess('Session rejointe avec succès');
                    // Rediriger vers l'interface de dégustation
                    // Pour l'instant, juste afficher un message
                    setTimeout(() => {
                        showError('Interface de dégustation en cours de développement');
                    }, 1500);
                } else {
                    showError('Erreur: ' + (response.message || 'Erreur lors de l\'adhésion'));
                }
            } catch (error) {
                console.error('❌ Erreur rejoindre session:', error);
                showError('Erreur: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        // Charger l'historique des dégustations du testeur
        async function loadTesterTastings() {
            console.log('🔧 loadTesterTastings() appelée');
            
            const listEl = document.getElementById('tester-tastings-list');
            listEl.innerHTML = '<p class="no-data">Fonction en cours de développement</p>';
            
            // TODO: Implémenter la récupération des dégustations du testeur
        }
        
        // Charger les classements pour le testeur
        async function loadTesterRankings() {
            console.log('🔧 loadTesterRankings() appelée');
            
            const listEl = document.getElementById('tester-rankings-list');
            listEl.innerHTML = '<p class="no-data">Fonction en cours de développement</p>';
            
            // TODO: Implémenter la récupération des classements pour le testeur
        }

        // === GESTION DES SESSIONS ===
        
        // Variable globale pour stocker l'ID de la session actuelle
        let currentSessionId = null;
        
        // Fonction principale pour gérer une session
        async function manageTastingSession(sessionId) {
            console.log('🔧 manageTastingSession() appelée avec ID:', sessionId);
            
            if (!api.isArbitre()) {
                console.error('❌ Not arbitre');
                showError('Accès refusé - Rôle arbitre requis');
                return;
            }
            
            try {
                setLoading(true);
                currentSessionId = sessionId;
                
                // Récupérer les détails de la session (avec cache-busting)
                const response = await api.getSession(sessionId);
                console.log('📡 Réponse session:', response);
                
                if (response.success) {
                    console.log('✅ Réponse session réussie');
                    console.log('📊 Structure response.data:', Object.keys(response.data || {}));
                    
                    const session = response.data.session;
                    const bottles = response.data.bottles || [];
                    const participants = response.data.participants || [];
                    
                    console.log('🔍 Session:', session);
                    console.log('🍾 Bottles count:', bottles.length, bottles);
                    console.log('👥 Participants count:', participants.length, participants);
                    
                    // Mettre à jour le nom de la session
                    document.getElementById('current-session-name').textContent = session.name;
                    document.getElementById('current-session-status').textContent = session.status || 'setup';
                    
                    // Afficher l'écran de gestion
                    showScreen('session-management-screen');
                    
                    // Charger les données dans les onglets
                    console.log('🔄 Chargement des bouteilles...');
                    loadSessionBottles(bottles);
                    console.log('🔄 Chargement des participants...');
                    loadSessionParticipants(participants);
                    console.log('🔄 Mise à jour du résumé...');
                    updateSessionSummary(bottles.length, participants.length, session.status);
                    
                    // Activer l'onglet bouteilles par défaut
                    showSessionTab('bottles');
                } else {
                    showError('Erreur: ' + (response.message || 'Erreur lors de la récupération de la session'));
                }
                
            } catch (error) {
                console.error('❌ Erreur gestion session:', error);
                showError('Erreur lors du chargement de la session: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        // Fonction pour basculer entre les onglets
        function showSessionTab(tabName) {
            console.log('🔧 showSessionTab:', tabName);
            
            // Cacher tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Afficher l'onglet sélectionné
            document.getElementById(`session-${tabName}-tab`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Charger les données spécifiques à l'onglet
            if (tabName === 'participants') {
                console.log('🔧 Chargement automatique des participants pour l\'onglet');
                loadAndDisplayParticipants();
            }
        }
        
        // Charger les bouteilles de la session
        function loadSessionBottles(bottles) {
            console.log('🍾 Chargement des bouteilles:', bottles);
            
            const listEl = document.getElementById('session-bottles-list');
            listEl.innerHTML = '';
            
            if (!bottles || bottles.length === 0) {
                listEl.innerHTML = '<p class="no-data">Aucune bouteille configurée pour cette session</p>';
                return;
            }
            
            bottles.forEach(bottle => {
                const bottleEl = document.createElement('div');
                bottleEl.className = 'bottle-item';
                bottleEl.innerHTML = `
                    <div class="bottle-display">
                        <div class="bottle-line-1">
                            <strong>Bouteille ${bottle.bottle_number}</strong>
                        </div>
                        <div class="bottle-line-2">
                            ${bottle.custom_name}
                        </div>
                        <div class="bottle-line-3">
                            ${bottle.wine_details || 'Aucun détail'}
                        </div>
                        <div class="bottle-line-4">
                            Ajoutée le ${new Date(bottle.created_at).toLocaleDateString('fr-FR')}
                        </div>
                        <div class="bottle-line-5">
                            <button class="btn-danger btn-small" onclick="removeBottleFromCurrentSession(${bottle.id})">
                                <span class="icon">🗑️</span>
                                Supprimer
                            </button>
                        </div>
                    </div>
                `;
                listEl.appendChild(bottleEl);
            });
        }
        
        // Charger les participants de la session
        function loadSessionParticipants(participants) {
            console.log('👥 Chargement des participants pour session:', currentSessionId);
            console.log('👥 Données participants reçues:', participants);
            console.log('👥 Type:', typeof participants, 'Length:', participants ? participants.length : 'N/A');
            
            const listEl = document.getElementById('session-participants-list');
            if (!listEl) {
                console.error('❌ Element session-participants-list non trouvé');
                return;
            }
            
            listEl.innerHTML = '';
            
            if (!participants || participants.length === 0) {
                console.log('ℹ️ Aucun participant à afficher');
                listEl.innerHTML = '<p class="no-data">Aucun participant ajouté à cette session</p>';
                return;
            }
            
            console.log('👥 Affichage de', participants.length, 'participant(s)');
            
            participants.forEach((participant, index) => {
                console.log(`👥 Participant ${index + 1}:`, participant);
                const participantEl = document.createElement('div');
                participantEl.className = 'participant-item';
                participantEl.innerHTML = `
                    <div class="participant-display">
                        <div class="participant-line-1">
                            <strong>${participant.first_name || participant.username}</strong>
                        </div>
                        <div class="participant-line-2">
                            ${participant.email}
                        </div>
                        <div class="participant-line-3">
                            Rejoint le ${new Date(participant.joined_at || participant.created_at).toLocaleDateString('fr-FR')}
                        </div>
                        <div class="participant-line-4">
                            <span class="status ${participant.status || 'waiting'}">
                                ${participant.status === 'active' ? 'Actif' : 'En attente'}
                            </span>
                        </div>
                        <div class="participant-line-5">
                            <button class="btn-danger btn-small" onclick="removeParticipantFromCurrentSession(${participant.user_id})">
                                <span class="icon">🗑️</span>
                                Retirer
                            </button>
                        </div>
                    </div>
                `;
                listEl.appendChild(participantEl);
            });
        }
        
        // Mettre à jour le résumé de la session
        function updateSessionSummary(bottleCount, participantCount, status) {
            document.getElementById('session-bottle-count').textContent = bottleCount;
            document.getElementById('session-participant-count').textContent = participantCount;
            
            // Afficher les boutons appropriés selon le statut
            const activateBtn = document.getElementById('activate-session-btn');
            const completeBtn = document.getElementById('complete-session-btn');
            const archiveBtn = document.getElementById('archive-session-btn');
            
            // Cacher tous les boutons
            activateBtn.style.display = 'none';
            completeBtn.style.display = 'none';
            archiveBtn.style.display = 'none';
            
            switch(status) {
                case 'setup':
                    if (bottleCount > 0 && participantCount > 0) {
                        activateBtn.style.display = 'inline-flex';
                    }
                    break;
                case 'active':
                    completeBtn.style.display = 'inline-flex';
                    break;
                case 'completed':
                    archiveBtn.style.display = 'inline-flex';
                    break;
            }
        }
        
        // Fonctions de gestion du statut de session
        async function activateSession() {
            // Vérifications avant activation
            const bottleCount = parseInt(document.getElementById('session-bottle-count').textContent);
            const participantCount = parseInt(document.getElementById('session-participant-count').textContent);
            
            if (bottleCount === 0) {
                showError('Impossible d\'activer la session : aucune bouteille ajoutée');
                return;
            }
            
            if (participantCount === 0) {
                showError('Impossible d\'activer la session : aucun participant ajouté');
                return;
            }
            
            // Confirmation avant activation
            const confirmation = confirm(`Êtes-vous sûr de vouloir activer cette session ?\n\n- ${bottleCount} bouteille(s)\n- ${participantCount} participant(s)\n\nL'activation désactivera toutes les autres sessions actives.`);
            
            if (!confirmation) {
                return;
            }
            
            await updateSessionStatus('active');
        }
        
        async function completeSession() {
            await updateSessionStatus('completed');
        }
        
        async function archiveSession() {
            await updateSessionStatus('archived');
        }
        
        async function updateSessionStatus(newStatus) {
            if (!currentSessionId) {
                showError('Aucune session sélectionnée');
                return;
            }
            
            try {
                setLoading(true);
                const response = await api.updateSessionStatus(currentSessionId, newStatus);
                
                if (response.success) {
                    showSuccess(`Session ${newStatus === 'active' ? 'activée' : newStatus === 'completed' ? 'terminée' : 'archivée'} avec succès`);
                    // Recharger la session pour mettre à jour l'affichage
                    manageTastingSession(currentSessionId);
                } else {
                    showError('Erreur: ' + (response.message || 'Erreur lors de la mise à jour'));
                }
            } catch (error) {
                console.error('❌ Erreur mise à jour statut:', error);
                showError('Erreur lors de la mise à jour: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        // Fonctions d'ajout/suppression de bouteilles et participants
        function showAddBottleToCurrentSession() {
            if (!currentSessionId) {
                showError('Aucune session sélectionnée');
                return;
            }
            // Réutiliser l'écran existant mais avec la session actuelle
            window.currentSessionForBottle = currentSessionId;
            document.getElementById('bottle-session-name').textContent = document.getElementById('current-session-name').textContent;
            showScreen('create-bottle-screen');
        }
        
        function showAddParticipantToCurrentSession() {
            if (!currentSessionId) {
                showError('Aucune session sélectionnée');
                return;
            }
            
            // Mettre à jour le nom de la session dans l'écran
            document.getElementById('participant-session-name').textContent = document.getElementById('current-session-name').textContent;
            
            // Vider les champs du formulaire
            document.getElementById('new-session-participant-name').value = '';
            document.getElementById('new-session-participant-email').value = '';
            
            // Afficher l'écran de création de participant pour session
            showScreen('create-session-participant-screen');
        }
        
        async function addBottleToSession() {
            try {
                setLoading(true);
                
                // Récupérer les valeurs du formulaire
                const bottleNumber = document.getElementById('new-bottle-number').value;
                const customName = document.getElementById('new-bottle-name').value;
                const wineDetails = document.getElementById('new-bottle-details').value;
                
                // Validation
                if (!bottleNumber || bottleNumber < 1) {
                    showError('Le numéro de bouteille doit être un nombre positif');
                    setLoading(false);
                    return;
                }
                
                if (!customName || customName.trim() === '') {
                    showError('Le nom personnalisé est requis');
                    setLoading(false);
                    return;
                }
                
                // Préparer les données
                const bottleData = {
                    bottleNumber: parseInt(bottleNumber, 10),
                    customName: customName.trim(),
                    wineDetails: wineDetails ? wineDetails.trim() : ''
                };
                
                console.log('🍾 Ajout de bouteille:', bottleData, 'à la session:', currentSessionId);
                
                // Appeler l'API
                const response = await api.addBottleToSession(currentSessionId, bottleData);
                
                if (response.success) {
                    showSuccess('Bouteille ajoutée avec succès');
                    
                    // Réinitialiser le formulaire
                    document.getElementById('new-bottle-number').value = '';
                    document.getElementById('new-bottle-name').value = '';
                    document.getElementById('new-bottle-details').value = '';
                    
                    // Recharger la session pour voir la nouvelle bouteille
                    manageTastingSession(currentSessionId);
                } else {
                    showError('Erreur: ' + (response.message || 'Erreur lors de l\'ajout de la bouteille'));
                }
                
                setLoading(false);
            } catch (error) {
                console.error('❌ Erreur lors de l\'ajout de la bouteille:', error);
                showError('Erreur lors de l\'ajout de la bouteille: ' + (error.message || 'Erreur inconnue'));
                setLoading(false);
            }
        }
        
        async function removeBottleFromCurrentSession(bottleId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cette bouteille ?')) {
                return;
            }
            
            try {
                setLoading(true);
                const response = await api.removeBottleFromSession(bottleId);
                
                if (response.success) {
                    showSuccess('Bouteille supprimée avec succès');
                    // Recharger la session
                    manageTastingSession(currentSessionId);
                } else {
                    showError('Erreur: ' + (response.message || 'Erreur lors de la suppression'));
                }
            } catch (error) {
                console.error('❌ Erreur suppression bouteille:', error);
                showError('Erreur lors de la suppression: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        async function removeParticipantFromCurrentSession(userId) {
            if (!confirm('Êtes-vous sûr de vouloir retirer ce participant de la session ?')) {
                return;
            }
            
            try {
                setLoading(true);
                // L'API ne semble pas avoir cette fonction, il faudra l'implémenter
                showError('Fonction de suppression de participant en cours de développement');
            } catch (error) {
                console.error('❌ Erreur suppression participant:', error);
                showError('Erreur lors de la suppression: ' + error.message);
            } finally {
                setLoading(false);
            }
        }
        
        // === CRÉATION DE PARTICIPANTS POUR SESSION ===
        
        async function createSessionParticipant() {
            console.log('🔧 createSessionParticipant() appelée pour session:', currentSessionId);
            
            if (!api.isArbitre()) {
                console.error('❌ Not arbitre');
                showError('Accès refusé - Rôle arbitre requis');
                return;
            }
            
            if (!currentSessionId) {
                showError('Aucune session sélectionnée');
                return;
            }

            const firstNameEl = document.getElementById('new-session-participant-name');
            const emailEl = document.getElementById('new-session-participant-email');
            
            console.log('🔧 Elements trouvés:', {
                firstName: !!firstNameEl,
                email: !!emailEl
            });
            
            if (!firstNameEl || !emailEl) {
                console.error('❌ Éléments introuvables');
                showError('Erreur: champs introuvables');
                return;
            }
            
            const firstName = firstNameEl.value.trim();
            const email = emailEl.value.trim();
            
            console.log('🔧 Valeurs:', { firstName, email });
            
            if (!firstName || !email) {
                console.error('❌ Champs vides');
                showError('Veuillez remplir tous les champs');
                return;
            }
            
            try {
                setLoading(true);
                
                // Étape 1: Vérifier si l'utilisateur existe déjà
                console.log('📡 Vérification de l\'existence de l\'utilisateur pour email:', email);
                let existingUser = null;
                let newUserId = null;
                
                try {
                    const usersResponse = await api.getAllUsers();
                    console.log('📡 Réponse getAllUsers:', usersResponse);
                    if (usersResponse.success && usersResponse.data) {
                        console.log('📊 Nombre d\'utilisateurs récupérés:', usersResponse.data.length);
                        console.log('📊 Emails des utilisateurs:', usersResponse.data.map(u => u.email));
                        
                        existingUser = usersResponse.data.find(user => {
                            const userEmail = user.email ? user.email.toLowerCase() : '';
                            const searchEmail = email.toLowerCase();
                            console.log('🔍 Comparaison:', userEmail, '===', searchEmail, '?', userEmail === searchEmail);
                            return userEmail === searchEmail;
                        });
                        console.log('👤 Utilisateur existant trouvé:', existingUser);
                    }
                } catch (userCheckError) {
                    console.error('⚠️ Erreur vérification utilisateur:', userCheckError);
                    console.log('⚠️ Continuons avec création...');
                }
                
                if (existingUser) {
                    // L'utilisateur existe déjà, on l'ajoute directement à la session
                    console.log('✅ Utilisateur existant détecté, ajout à la session...');
                    newUserId = existingUser.id;
                    setLoading(false);
                    
                    showSuccess('Utilisateur existant trouvé, ajout à la session en cours...');
                    
                    // Vider les champs
                    firstNameEl.value = '';
                    emailEl.value = '';
                } else {
                    // L'utilisateur n'existe pas, on le crée
                    console.log('📡 Appel API createUser...');
                    const response = await api.createUser({ firstName, email });
                    console.log('📡 Réponse API:', response);
                    
                    console.log('🔍 Réponse complète de createUser:', JSON.stringify(response, null, 2));
                    
                    if (response.success) {
                    // Arrêter le loading IMMÉDIATEMENT
                    setLoading(false);
                    
                    // Message de succès avec détails
                    const successMsg = response.emailSent 
                        ? 'Participant créé avec succès • Email d\'invitation envoyé'
                        : 'Participant créé avec succès • Email simulé (mode développement)';
                    
                    showSuccess(successMsg);
                    
                    // Vider les champs IMMÉDIATEMENT
                    firstNameEl.value = '';
                    emailEl.value = '';
                    
                        console.log('📧 Lien d\'activation:', response.activationLink);
                        
                        // CORRECTION SIMPLE : Skip l'ajout à la session pour éviter l'erreur
                        console.log('✅ Participant créé avec succès - Navigation directe');
                        console.log('📧 Lien d\'activation:', response.activationLink);
                        
                        // Ne pas essayer de récupérer l'ID pour éviter l'erreur
                        // Navigation directe vers la gestion de session
                    } else {
                        // Arrêter le loading en cas d'erreur
                        setLoading(false);
                        
                        // Gestion des erreurs spécifiques
                        if (response.message && (response.message.includes('existe déjà') || response.message.includes('UNIQUE constraint'))) {
                            console.log('🔄 Utilisateur existe déjà mais non détecté, tentative de récupération...');
                            
                            // Tenter de récupérer l'utilisateur existant et l'ajouter à la session
                            try {
                                const usersResponse = await api.getAllUsers();
                                if (usersResponse.success && usersResponse.data) {
                                    const existingUser = usersResponse.data.find(user => 
                                        user.email && user.email.toLowerCase() === email.toLowerCase()
                                    );
                                    
                                    if (existingUser) {
                                        console.log('✅ Utilisateur existant récupéré après erreur:', existingUser);
                                        newUserId = existingUser.id;
                                        showSuccess('Utilisateur existant trouvé, ajout à la session...');
                                        
                                        // Vider les champs
                                        firstNameEl.value = '';
                                        emailEl.value = '';
                                    } else {
                                        showError('Ce participant existe déjà. Veuillez utiliser un email différent.');
                                        return;
                                    }
                                } else {
                                    showError('Ce participant existe déjà. Veuillez utiliser un email différent.');
                                    return;
                                }
                            } catch (fallbackError) {
                                console.error('❌ Erreur fallback récupération utilisateur:', fallbackError);
                                showError('Ce participant existe déjà. Veuillez utiliser un email différent.');
                                return;
                            }
                        } else {
                            showError('Erreur: ' + (response.message || 'Erreur inconnue'));
                            return;
                        }
                    }
                }
                
                // Étape commune: Ajouter le participant à la session (qu'il soit nouveau ou existant)
                if (newUserId) {
                    console.log('👤 Nouvel utilisateur créé avec ID:', newUserId);
                    
                    try {
                        console.log('📡 Ajout du participant à la session...');
                        const sessionResponse = await api.addParticipantToSession(currentSessionId, newUserId);
                        console.log('📡 Réponse ajout à la session:', sessionResponse);
                        
                        if (sessionResponse.success) {
                            console.log('✅ Participant ajouté à la session avec succès');
                            showSuccess('Participant ajouté à la session avec succès');
                        } else {
                            console.error('❌ Erreur ajout à la session:', sessionResponse.message);
                            
                            // Vérifier si l'utilisateur est déjà dans la session
                            if (sessionResponse.message && sessionResponse.message.includes('déjà inscrit')) {
                                console.log('ℹ️ Utilisateur déjà inscrit à la session');
                                showSuccess('Participant déjà inscrit à cette session');
                            } else {
                                showError('Erreur lors de l\'ajout à la session: ' + (sessionResponse.message || 'Erreur inconnue'));
                            }
                        }
                    } catch (sessionError) {
                        console.error('❌ Erreur ajout à la session:', sessionError);
                        showError('Participant créé mais erreur lors de l\'ajout à la session: ' + sessionError.message);
                    }
                    
                    // Navigation avec délai pour s'assurer que l'ajout est terminé
                    console.log('🔄 Navigation vers la gestion de session...');
                    setTimeout(() => {
                        try {
                            console.log('🔄 Retour vers session management...');
                            backToSessionManagement();
                            
                            // Attendre un peu puis recharger la session
                            setTimeout(() => {
                                console.log('🔄 Rechargement de la session:', currentSessionId);
                                manageTastingSession(currentSessionId).then(() => {
                                    // Basculer vers l'onglet participants après chargement
                                    setTimeout(() => {
                                        console.log('🔄 Basculement vers onglet participants');
                                        showSessionTab('participants');
                                    }, 200);
                                }).catch(reloadError => {
                                    console.error('❌ Erreur rechargement session:', reloadError);
                                });
                            }, 300);
                            
                            console.log('🔄 Navigation programmée');
                        } catch (error) {
                            console.error('❌ Erreur navigation:', error);
                        }
                    }, 1000);
                }
                
            } catch (error) {
                console.error('❌ Erreur création participant:', error);
                showError('Erreur lors de la création: ' + error.message);
                setLoading(false);
            }
        }
        
        // === FONCTIONS D'AFFICHAGE DES PARTICIPANTS ===
        
        async function loadAndDisplayParticipants() {
            console.log('🔧 Chargement de la liste des participants...');
            
            try {
                if (!api.isArbitre()) {
                    console.log('❌ Seuls les arbitres peuvent voir les participants');
                    return;
                }
                
                // Récupérer tous les utilisateurs
                const response = await api.getAllUsers();
                
                if (response.success && response.data) {
                    console.log('✅ Participants récupérés:', response.data);
                    displayParticipantsList(response.data);
                } else {
                    console.log('⚠️ Aucun participant trouvé ou erreur:', response);
                    displayEmptyParticipantsList();
                }
                
            } catch (error) {
                console.error('❌ Erreur chargement participants:', error);
                displayEmptyParticipantsList('Erreur lors du chargement des participants');
            }
        }
        
        function displayParticipantsList(participants) {
            console.log('🎯 Affichage de', participants.length, 'participants');
            
            // Trouver le conteneur des participants 
            const participantsContainer = document.getElementById('session-participants-list');
            if (!participantsContainer) {
                console.error('❌ Conteneur participants introuvable');
                return;
            }
            
            // Vider le conteneur
            participantsContainer.innerHTML = '';
            
            if (participants.length === 0) {
                displayEmptyParticipantsList();
                return;
            }
            
            // Afficher chaque participant
            participants.forEach(participant => {
                const participantElement = createParticipantElement(participant);
                participantsContainer.appendChild(participantElement);
            });
        }
        
        function createParticipantElement(participant) {
            const div = document.createElement('div');
            div.className = 'participant-item';
            
            const roleBadge = participant.role === 'arbitre' ? 
                '<span style="background: #8B0000; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">ARBITRE</span>' :
                '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">TESTEUR</span>';
            
            const statusBadge = participant.needs_password_setup ? 
                '<span style="background: #FF9800; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">EN ATTENTE</span>' :
                '<span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">ACTIF</span>';
            
            div.innerHTML = `
                <div class="participant-info">
                    <div class="participant-name">
                        <strong>${participant.first_name || participant.username}</strong>
                        ${roleBadge}
                        ${statusBadge}
                    </div>
                    <div class="participant-email">${participant.email}</div>
                    <div class="participant-created">
                        Créé le: ${new Date(participant.created_at).toLocaleDateString('fr-FR')}
                    </div>
                </div>
                <div class="participant-actions">
                    ${participant.role !== 'arbitre' ? `
                        <button class="btn-danger btn-small" onclick="deleteParticipant('${participant.id}', '${participant.email}')">
                            <span class="icon">🗑️</span> Supprimer
                        </button>
                    ` : ''}
                </div>
            `;
            
            return div;
        }
        
        function displayEmptyParticipantsList(message = 'Aucun participant créé') {
            const participantsContainer = document.getElementById('session-participants-list');
            if (participantsContainer) {
                participantsContainer.innerHTML = `
                    <div class="empty-message">
                        <span class="icon">👥</span>
                        ${message}
                    </div>
                `;
            }
        }
        
        async function deleteParticipant(userId, email) {
            if (!confirm(`Êtes-vous sûr de vouloir supprimer le participant ${email} ?`)) {
                return;
            }
            
            try {
                console.log('🗑️ Suppression participant:', userId, email);
                const response = await api.deleteUser(userId);
                
                if (response.success) {
                    console.log('✅ Participant supprimé');
                    showSuccess('Participant supprimé avec succès');
                    // Recharger la liste
                    await loadAndDisplayParticipants();
                } else {
                    throw new Error(response.message || 'Erreur lors de la suppression');
                }
                
            } catch (error) {
                console.error('❌ Erreur suppression participant:', error);
                showError('Erreur lors de la suppression: ' + error.message);
            }
        }
        
        function backToSessionManagement() {
            if (!currentSessionId) {
                showAdminSessions();
                return;
            }
            
            // Retourner à l'écran de gestion de session
            showScreen('session-management-screen');
        }

        // Initialize
        // Amélioration des interactions tactiles mobiles
        function enhanceMobileInteractions() {
            // Détecter si on est sur mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                console.log('📱 Mode mobile détecté - Améliorations tactiles activées');
                
                // Améliorer tous les boutons pour le tactile
                document.addEventListener('touchstart', function(e) {
                    if (e.target.matches('button, .btn-primary, .btn-secondary, .btn-danger, [onclick]')) {
                        e.target.style.transform = 'scale(0.98)';
                        e.target.style.transition = 'transform 0.1s ease';
                    }
                }, { passive: true });
                
                document.addEventListener('touchend', function(e) {
                    if (e.target.matches('button, .btn-primary, .btn-secondary, .btn-danger, [onclick]')) {
                        setTimeout(() => {
                            e.target.style.transform = 'scale(1)';
                        }, 100);
                    }
                }, { passive: true });
                
                // Force la réactivité des clics (version corrigée)
                document.addEventListener('touchend', function(e) {
                    const target = e.target;
                    if (target.matches('button, .btn-primary, .btn-secondary, .btn-danger, [onclick]')) {
                        // Ne pas empêcher le comportement par défaut pour les vrais clics
                        // e.preventDefault(); 
                        
                        // Laisser le navigateur gérer le clic naturellement
                        // Le onclick sera déclenché automatiquement
                        console.log('📱 Touch sur:', target.tagName, target.className);
                    }
                }, { passive: true });
                
                // Éviter le double-tap zoom
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
        }

        // Console mobile pour debug
        function createMobileConsole() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                const consoleDiv = document.createElement('div');
                consoleDiv.id = 'mobile-console';
                consoleDiv.style.cssText = `
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    max-height: 200px;
                    background: rgba(0,0,0,0.9);
                    color: #00ff00;
                    font-family: monospace;
                    font-size: 10px;
                    padding: 10px;
                    overflow-y: auto;
                    z-index: 9999;
                    display: none;
                `;
                document.body.appendChild(consoleDiv);
                
                // Bouton pour toggle la console
                const toggleBtn = document.createElement('button');
                toggleBtn.innerHTML = '🐛';
                toggleBtn.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    z-index: 10000;
                    background: #ff4444;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    font-size: 16px;
                `;
                document.body.appendChild(toggleBtn);
                
                let consoleVisible = false;
                toggleBtn.onclick = () => {
                    consoleVisible = !consoleVisible;
                    consoleDiv.style.display = consoleVisible ? 'block' : 'none';
                };
                
                // Intercepter console.log pour mobile
                const originalLog = console.log;
                console.log = function(...args) {
                    originalLog.apply(console, args);
                    const logDiv = document.createElement('div');
                    logDiv.textContent = args.join(' ');
                    consoleDiv.appendChild(logDiv);
                    consoleDiv.scrollTop = consoleDiv.scrollHeight;
                };
                
                const originalError = console.error;
                console.error = function(...args) {
                    originalError.apply(console, args);
                    const errorDiv = document.createElement('div');
                    errorDiv.textContent = '❌ ' + args.join(' ');
                    errorDiv.style.color = '#ff4444';
                    consoleDiv.appendChild(errorDiv);
                    consoleDiv.scrollTop = consoleDiv.scrollHeight;
                };
            }
        }

        document.addEventListener('DOMContentLoaded', checkAuthentication);
        document.addEventListener('DOMContentLoaded', enhanceMobileInteractions);
        document.addEventListener('DOMContentLoaded', createMobileConsole);
    </script>
</body>
</html>
